<template>
  <div id="bpmnModel" width="100%" height="100%" />
</template>

<script>
  import { getImage } from '../../api/workflow/activiti'
  import Raphael from 'raphael'
  import $ from 'jquery'
  import draw from '@/utils/bpmn-draw'

  var paper
  var NORMAL_STROKE = 1
  var SEQUENCEFLOW_STROKE = 1.5
  var TASK_STROKE = 1
  var CALL_ACTIVITY_STROKE = 2
  var ENDEVENT_STROKE = 3
  var CURRENT_ACTIVITY_STROKE = 2

  var COMPLETED_COLOR = '#2674aa'
  var TEXT_COLOR = '#373e48'
  var CURRENT_COLOR = '#66AA66'
  var HOVER_COLOR = '#666666'
  var ACTIVITY_STROKE_COLOR = '#bbbbbb'
  var ACTIVITY_FILL_COLOR = '#f9f9f9'
  var MAIN_STROKE_COLOR = '#585858'

  var TEXT_PADDING = 3
  var ARROW_WIDTH = 4
  var MARKER_WIDTH = 12

  // icons
  var ICON_SIZE = 16
  var ICON_PADDING = 4

  var INITIAL_CANVAS_WIDTH
  var INITIAL_CANVAS_HEIGHT

  var viewBox
  var viewBoxWidth
  var viewBoxHeight

  var canvasWidth
  var canvasHeight
  var elementsAdded = new Array()
  var elementsRemoved = new Array()

  export default {
    name: 'FlowImage',
    props: {
      definitionId: {
        type: String,
        default: null,
        required: true
      },
      instanceId: {
        type: String,
        default: null,
        required: false
      }

    },
    mounted() {
      this.initHandle()
    },
    methods: {
      // 初始化值
      initHandle() {
        const _this = this

        const TASK_FONT = { font: '11px Arial', opacity: 1, fill: Raphael.rgb(0, 0, 0) }

        getImage(this.definitionId, this.instanceId).then(data => {
          console.log('===========>', data)
          INITIAL_CANVAS_WIDTH = data.diagramWidth + 20
          INITIAL_CANVAS_HEIGHT = data.diagramHeight + 50
          canvasWidth = INITIAL_CANVAS_WIDTH
          canvasHeight = INITIAL_CANVAS_HEIGHT
          viewBoxWidth = INITIAL_CANVAS_WIDTH
          viewBoxHeight = INITIAL_CANVAS_HEIGHT

          var x = 0
          if (document.documentElement.clientWidth > canvasWidth) {
            x = (document.documentElement.clientWidth - canvasWidth) / 2 - (data.diagramBeginX / 2)
          }

          document.getElementById('bpmnModel').width = INITIAL_CANVAS_WIDTH
          document.getElementById('bpmnModel').height = INITIAL_CANVAS_HEIGHT
          paper = Raphael('bpmnModel', canvasWidth, canvasHeight)
          paper.setViewBox(0, 0, viewBoxWidth, viewBoxHeight, false)
          paper.renderfix()

          if (data.pools) {
            for (var i = 0; i < data.pools.length; i++) {
              var pool = data.pools[i]
              _drawPool(pool)
            }
          }

          var modelElements = data.elements
          for (var i = 0; i < modelElements.length; i++) {
            var element = modelElements[i]
            // try {
            console.log('==============>>>>>>_draw' + element.type)
            draw['_draw' + element.type](paper, element)
            // var drawFunction = eval('_draw' + element.type)
            // drawFunction(element)
            // } catch(err) {console.log(err);}
          }

          if (data.flows) {
            for (var i = 0; i < data.flows.length; i++) {
              var flow = data.flows[i]
              draw._drawFlow(paper, flow)
            }
          }
        })
      }
    }
  }
</script>

<style scoped>

</style>
