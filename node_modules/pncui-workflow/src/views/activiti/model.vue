<template>
  <div class="app-container">
    <div class="head-container">
      <div>
        <el-input v-model="query.modelKey" clearable size="small" placeholder="请输入Key" style="width: 200px;"
                  class="filter-item" @keyup.enter.native="refresh"/>
        <el-input v-model="query.modelName" clearable size="small" placeholder="请输入名称" style="width: 200px;"
                  class="filter-item" @keyup.enter.native="refresh"/>
        <el-button class="filter-item" type="success" icon="el-icon-search" @click="refresh">搜索</el-button>
        <el-button class="filter-item" type="primary" icon="el-icon-plus" @click="showAdd=true">添加</el-button>
        <el-button class="filter-item" type="warning" icon="el-icon-upload" @click="showImport=true">导入</el-button>
      </div>
    </div>
    <!--表格渲染-->
    <el-table ref="table" v-loading="loading" :data="rows" style="width: 100%;">
      <el-table-column prop="id" label="ID"/>
      <el-table-column prop="name" label="名称"/>
      <el-table-column prop="key" label="关键字"/>
      <!--<el-table-column prop="category" label="分类"/>-->
      <el-table-column prop="version" label="版本"/>
      <el-table-column prop="createTime" label="创建时间" :formatter="timeColumnFormat"/>
      <el-table-column prop="deploymentId" label="部署ID"/>
      <el-table-column
        v-permission="['model:del','model:edit','model:pub']"
        label="操作"
        width="120"
        align="center"
        fixed="right"
      >
        <template slot-scope="scope">
          <el-tooltip content="编辑">
            <el-button type="text" icon="el-icon-edit"
                       permission="['model:edit']"
                       @click="editModel(scope.row)">
            </el-button>
          </el-tooltip>
          <el-tooltip content="删除">
            <el-button type="text" icon="el-icon-delete"
                       permission="['model:del']"
                       @click="delModel(scope.row)">
            </el-button>
          </el-tooltip>
          <el-tooltip content="发布">
            <el-button type="text" icon="el-icon-upload"
                       permission="['model:pub']"
                       @click="pubModel(scope.row)">
            </el-button>
          </el-tooltip>
          <el-tooltip content="导出">
            <el-button type="text" icon="el-icon-download"
                       permission="['model:exp']"
                       @click="expModel(scope.row)">
            </el-button>
          </el-tooltip>
        </template>
      </el-table-column>
    </el-table>
    <!--分页组件-->
    <el-pagination
      :page-size.sync="page.size"
      :total="page.total"
      :current-page.sync="page.page"
      style="margin-top: 8px;"
      layout="total, prev, pager, next, sizes"
      @size-change="sizeChangeHandler($event)"
      @current-change="pageChangeHandler"
    />

    <el-dialog
      append-to-body
      :close-on-click-modal="false"
      :visible.sync="showEdit"
      :title="modelName"
      fullscreen
      @close="refresh"
      class="no-padding"
    >
      <FlowEditor :model-id="modelId"></FlowEditor>
    </el-dialog>

    <el-dialog
      append-to-body
      :close-on-click-modal="false"
      :visible.sync="showAdd"
      title="新增模型"
      width="500px"
      height="200px"
    >
      <el-form ref="form" :inline="true" :model="form" :rules="rules" label-width="120px">
        <el-form-item label="KEY" prop="modelKey">
          <el-input v-model="form.modelKey" placeholder="请输入KEY" style="width: 350px"/>
        </el-form-item>
        <el-form-item label="名称" prop="modelName">
          <el-input v-model="form.modelName" placeholder="请输入名称" style="width: 350px"/>
        </el-form-item>

      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button type="text" @click="showAdd=false">取消</el-button>
        <el-button type="primary" @click="doAddModel">确认</el-button>
      </div>
    </el-dialog>

    <el-dialog
      append-to-body
      :close-on-click-modal="false"
      :visible.sync="showPublish"
      title="选择流程文件"
      width="500px"
      height="200px"
    >
      <el-form ref="form" :inline="true" :model="form" :rules="rules2" label-width="120px">
        <el-form-item label="部署名称" prop="deployName">
          <el-input v-model="form.deployName" placeholder="请输入部署名称" style="width: 350px"/>
        </el-form-item>
        <el-form-item label="部署分类" prop="category">
          <el-input v-model="form.category" placeholder="请输入部署分类" style="width: 350px"/>
        </el-form-item>

      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button type="text" @click="showPublish=false">取消</el-button>
        <el-button type="primary" @click="doPublish">确认</el-button>
      </div>
    </el-dialog>

    <el-dialog
      append-to-body
      :close-on-click-modal="false"
      :visible.sync="showImport"
      title="导入模型"
      width="500px"
      height="200px"
    >
      <el-form ref="form" :inline="true" :model="form" :rules="rules3" label-width="120px">
        <el-form-item label="KEY" prop="modelKey">
          <el-input v-model="form.modelKey" placeholder="请输入KEY" style="width: 350px"/>
        </el-form-item>
        <el-form-item label="名称" prop="modelName">
          <el-input v-model="form.modelName" placeholder="请输入名称" style="width: 350px"/>
        </el-form-item>
        <el-form-item label="模型文件" prop="uploadFiles">
          <el-upload
            class="upload-demo"
            ref="upload"
            action="#"
            accept="bpmn"
            :on-remove="handleRemove"
            :file-list="form.uploadFiles"
            :http-request="handleChange"
            :auto-upload="false">
            <el-button slot="trigger" size="small" type="primary">选取文件</el-button>
            <div slot="tip" class="el-upload__tip">只能上传bpmn文件，且不超过500kb</div>
          </el-upload>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button type="text" @click="showAdd=false">取消</el-button>
        <el-button type="primary" @click="submitUpload">确认</el-button>
      </div>
    </el-dialog>

  </div>
</template>

<script>

  import { models, addModel, delModel, pubModel, expModel, impModel } from '../../api/workflow/activiti'
  import FlowEditor from '../../components/Activiti/FlowEditor'

  export default {
    name: 'Model',
    data() {
      return {
        rows: [],
        loading: false,
        showEdit: false,
        showAdd: false,
        showPublish: false,
        showImport: false,
        modelId: '',
        modelName: '',
        fileData: {},
        query: {
          modelName: '',
          modelKey: ''
        },
        form: {
          modelName: '',
          modelKey: '',
          deployName: '',
          category: '',
          id: '',
          uploadFiles: []
        },
        page: {
          // 页码
          start: 0,
          // 每页数据条数
          size: 10,
          // 总数据条数
          total: 0
        },
        rules: {
          modelName: [
            { required: true, message: '名称不能为空', trigger: 'blur' }
          ],
          modelKey: [
            { required: true, message: 'Key不能为空', trigger: 'blur' }
          ]
        },
        rules2: {
          deployName: [
            { required: true, message: '名称不能为空', trigger: 'blur' }
          ],
          category: [
            { required: true, message: '分类不能为空', trigger: 'blur' }
          ]
        },
        rules3: {
          modelName: [
            { required: true, message: '名称不能为空', trigger: 'blur' }
          ],
          modelKey: [
            { required: true, message: 'Key不能为空', trigger: 'blur' }
          ],
          uploadFiles: [{
            required: true, message: '模型文件不能为空', trigger: 'change'
          }]
        }
      }
    },
    components: { FlowEditor },
    mounted() {
      this.refresh()
    },
    methods: {
      refresh() {
        models({
            key: this.query.modelKey,
            name: this.query.modelName,
            size: this.page.size,
            page: this.page.start
          }
        ).then(res => {
          //console.log(res)
          this.rows = res.data.records
          this.page.total = res.data.total
        })
      },
      editModel(row) {
        this.modelId = row.id
        this.modelName = row.name
        this.showEdit = true
      },
      addModel() {
        this.showAdd = true
        this.query.modelKey = ''
        this.query.modelName = ''
      },
      doAddModel() {
        addModel(
          this.form.modelKey,
          this.form.modelName).then(res => {
          if (res.code === 0) {
            this.showAdd = false
            this.$message.success('添加成功' + res.data.id)
            this.refresh()
          } else {
            this.$message.error(res.msg || '添加失败')
          }
          /*this.editModel({
            id: res.data.id,
            name: this.form.modelName
          })*/
        })
      },
      delModel(row) {
        this.$confirm('确定要删除该模型吗？').then(() => {
          delModel(row.id).then(res => {
            if (res.code === 0) {
              this.refresh()
              this.$message.success('删除成功')
            } else {
              this.$message.error(res.msg)
            }

          })
        })
      },
      pubModel(row) {
        this.form.id = row.id
        this.form.deployName = row.name
        this.showPublish = true
      },
      doPublish() {
        pubModel(this.form.id, this.form).then(res => {
          if (res.code === 0) {
            this.showPublish = false
            this.$message.success('发布成功')
            this.refresh()

          } else {
            this.$message.error(res.msg)
          }
        })
      },
      expModel(row) {
        expModel(row.id).then(res => {
          const url = window.URL.createObjectURL(new Blob([res]))
          const link = document.createElement('a')
          link.style.display = 'none'
          link.href = url
          const fileName = (row.key || row.name) + '.bpmn'
          link.setAttribute('download', fileName)
          document.body.appendChild(link)
          link.click()
          document.body.removeChild(link)
        })
      },
      handleChange(param) {
        console.log('handchange--->>', param)
        this.fileData.append('file', param.file)//传文件
      },
      submitUpload() {
        this.fileData = new FormData()  // new formData对象
        console.log('submit>>', this.fileData)
        this.$refs.upload.submit()
        let fd = new FormData()
        fd.append('file', this.fileData)
        this.fileData.append('modelName', this.form.modelName)
        this.fileData.append('modelKey', this.form.modelKey)
        console.log('befor upload>>', fd)
        impModel(this.fileData).then(res => {
          if (res.code == 0) {
            this.showImport = false
            this.$message.success('导入成功')
            this.refresh()
          } else {
            this.$message.error(res.msg)
          }
        })
      },
      handleRemove(file, fileList) {
        console.log(file, fileList)
      },
      // 当前页改变
      pageChangeHandler(e) {
        this.page.start = e
        this.refresh()
      },
      // 每页条数改变
      sizeChangeHandler(e) {
        this.page.size = e
        this.page.start = 1
        this.refresh()
      }
    }
  }
</script>

<style>
  .no-padding .el-dialog__body {
    padding: 0px 0px 0px 0px !important;
  }
</style>
