<template>
  <div class="app-container">
    <!--表格渲染-->
    <el-table ref="table" v-loading="loading" :data="rows" style="width: 100%;">
      <el-table-column prop="id" label="ID"/>
      <el-table-column prop="businessKey" label="业务主键"/>
      <el-table-column prop="processDefinitionId" label="流程定义ID"/>
      <!-- <el-table-column v-if="columns.visible('address')" :show-overflow-tooltip="true" prop="address" label="IP来源" /> -->
      <el-table-column prop="startTime" label="开始时间" :formatter="timeColumnFormat"/>
      <el-table-column prop="endTime" label="结束时间" :formatter="timeColumnFormat"/>
      <el-table-column
        v-permission="['instance:image']"
        label="操作"
        width="60"
        align="center"
        fixed="right"
      >
        <template slot-scope="scope">
          <el-tooltip content="流程图">
            <el-button type="text" icon="el-icon-picture"
                       permission="['instance:image']"
                       @click="viewImage(scope.row)">
            </el-button>
          </el-tooltip>
        </template>
      </el-table-column>
    </el-table>
    <!--分页组件-->
    <el-pagination
      :page-size.sync="page.size"
      :total="page.total"
      :current-page.sync="page.page"
      style="margin-top: 8px;"
      layout="total, prev, pager, next, sizes"
      @size-change="sizeChangeHandler($event)"
      @current-change="pageChangeHandler"
    />

    <el-dialog
      append-to-body
      :close-on-click-modal="false"
      :visible.sync="showImage"
      title=""
      width="90%"
    >
      <flow-image :process-instance-id="current.processInstanceId"
                  :process-definition-id="current.processDefinitionId"></flow-image>

    </el-dialog>

  </div>
</template>

<script>

  import { instances } from '../../api/workflow/activiti'
  import FlowImage from '../../components/Activiti/FlowImage'

  export default {
    name: 'Instance',
    data() {
      return {
        rows: [],
        loading: false,
        current: {},
        showImage: false,
        page: {
          // 页码
          start: 0,
          // 每页数据条数
          size: 10,
          // 总数据条数
          total: 0
        }
      }
    },
    components: { FlowImage },
    mounted() {
      this.refresh()
    },
    methods: {
      refresh() {
        instances({
            order: 'desc',
            latest: true,
            sort: 'startTime',
            size: this.page.size,
            start: this.page.start
          }
        ).then(res => {
          //console.log(res)
          this.rows = res.data.data
          this.page.total = res.data.total
        })
      },
      viewImage(row) {
        this.current.processInstanceId = row.id
        this.current.processDefinitionId = row.processDefinitionId
        this.showImage = true
      },
      // 当前页改变
      pageChangeHandler(e) {
        this.page.start = e
        this.refresh()
      },
      // 每页条数改变
      sizeChangeHandler(e) {
        this.page.size = e
        this.page.start = 1
        this.refresh()
      }
    }
  }
</script>

<style>
  .demo-table-expand {
    font-size: 0;
  }

  .demo-table-expand label {
    width: 70px;
    color: #99a9bf;
  }

  .demo-table-expand .el-form-item {
    margin-right: 0;
    margin-bottom: 0;
    width: 100%;
  }

  .demo-table-expand .el-form-item__content {
    font-size: 12px;
  }
</style>
