<template>
  <div class="app-container">
    <!--表格渲染-->
    <el-table ref="table" v-loading="loading" :data="rows" style="width: 100%;">
      <el-table-column prop="id" label="ID"/>
      <el-table-column prop="name" label="名称"/>
      <!-- <el-table-column v-if="columns.visible('address')" :show-overflow-tooltip="true" prop="address" label="IP来源" /> -->
      <el-table-column prop="category" label="分类"/>
      <el-table-column prop="version" label="版本"/>
      <el-table-column prop="key" label="关键字"/>
      <el-table-column
        v-permission="['process:test']"
        label="操作"
        width="100"
        align="center"
        fixed="right"
      >
        <template slot-scope="scope">
          <el-tooltip content="流程图">
            <el-button type="text" icon="el-icon-picture"
                       permission="['instance:image']"
                       @click="viewImage(scope.row)">
            </el-button>
          </el-tooltip>
          <el-tooltip content="发起新流程">
            <el-button type="text" icon="el-icon-plus"
                       permission="['process:test']"
                       @click="toStartFlow(scope.row)">
            </el-button>
          </el-tooltip>
        </template>
      </el-table-column>
    </el-table>
    <!--分页组件-->
    <el-pagination
      :page-size.sync="page.size"
      :total="page.total"
      :current-page.sync="page.page"
      style="margin-top: 8px;"
      layout="total, prev, pager, next, sizes"
      @size-change="sizeChangeHandler($event)"
      @current-change="pageChangeHandler"
    />

    <el-dialog
      append-to-body
      :close-on-click-modal="false"
      :visible.sync="showImage"
      title=""
      top="5vh"
      width="90%"
    >
      <flow-image :process-id="form.processId"></flow-image>

    </el-dialog>

    <el-dialog
      append-to-body
      :close-on-click-modal="false"
      :visible.sync="startFlow"
      title="发起新流程"
      width="500px"
      height="200px"
    >
      <el-form ref="form" :inline="true" :model="form" :rules="rules" label-width="90px">
        <el-form-item label="业务主键" prop="businessKey">
          <el-input v-model="form.businessKey" placeholder="请输入业务主键" style="width: 350px">
          </el-input>
        </el-form-item>
        <el-form-item label="参数" prop="parameter">
          <el-input type="textarea" v-model="form.parameter" placeholder="请输入参数(JSON)" style="width: 350px"/>
        </el-form-item>

      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button type="text" @click="startFlow=false">取消</el-button>
        <el-button type="primary" @click="doStartFlow">启动</el-button>
      </div>
    </el-dialog>
  </div>
</template>

<script>

  import { definitions, startTestFlow } from '../../api/workflow/activiti'
  import FlowImage from '../../components/Activiti/FlowImage'

  export default {
    name: 'Definition',
    data() {
      return {
        rows: [],
        loading: false,
        startFlow: false,
        showImage: false,
        form: {
          processId: '',
          businessKey: '',
          parameter: ''
        },
        page: {
          // 页码
          start: 0,
          // 每页数据条数
          size: 10,
          // 总数据条数
          total: 0
        },
        rules: {
          businessKey: [
            { required: true, message: '业务主键不能为空', trigger: 'blur' }
          ]
        }
      }
    },
    components: { FlowImage },
    mounted() {
      this.refresh()
    },
    methods: {
      refresh() {
        definitions({
            order: 'asc',
            latest: true,
            sort: 'id',
            size: this.page.size,
            start: this.page.start
          }
        ).then(res => {
          //console.log(res)
          this.rows = res.data.data
          this.page.total = res.data.total
        })
      },
      viewImage(row) {
        this.form.processId = row.key
        this.showImage = true
      },
      toStartFlow(row) {
        this.startFlow = true
        this.form.processId = row.key
      },
      doStartFlow() {
        let parameter = {}
        if (this.form.parameter) {
          parameter = JSON.parse(this.form.parameter)
        }
        startTestFlow(this.form.processId, this.form.businessKey, parameter).then(res => {
          this.$message.success('流程发起成功:' + res.data)
          this.startFlow = false
        })
      },
      // 当前页改变
      pageChangeHandler(e) {
        this.page.start = e
        this.refresh()
      },
      // 每页条数改变
      sizeChangeHandler(e) {
        this.page.size = e
        this.page.start = 1
        this.refresh()
      }
    }
  }
</script>

<style>
  .demo-table-expand {
    font-size: 0;
  }

  .demo-table-expand label {
    width: 70px;
    color: #99a9bf;
  }

  .demo-table-expand .el-form-item {
    margin-right: 0;
    margin-bottom: 0;
    width: 100%;
  }

  .demo-table-expand .el-form-item__content {
    font-size: 12px;
  }
</style>
