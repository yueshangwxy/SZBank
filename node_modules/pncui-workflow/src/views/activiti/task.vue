<template>
  <div class="app-container">
    <div class="head-container">
      <div>
        <el-radio-group v-model="query.type" class="filter-item" @change="refresh">
          <el-radio-button permission="['task:all']" label="0">所有任务</el-radio-button>
          <el-radio-button label="1">待办任务</el-radio-button>
          <el-radio-button label="2">可办任务</el-radio-button>
          <el-radio-button label="3">已办任务</el-radio-button>
        </el-radio-group>

        <el-radio-group v-if="query.type == '0'" v-model="query.finished" class="filter-item" @change="refresh">
          <el-radio-button label="">全部</el-radio-button>
          <el-radio-button label="true">已完成</el-radio-button>
          <el-radio-button label="false">未完成</el-radio-button>
        </el-radio-group>
        <!-- <el-button class="filter-item" type="success" icon="el-icon-search" @click="refresh">搜索</el-button>-->
      </div>
    </div>
    <!--表格渲染-->
    <el-table ref="table" v-loading="loading" :data="rows" style="width: 100%;">
      <el-table-column prop="id" label="ID"/>
      <el-table-column prop="name" label="名称"/>
      <!-- <el-table-column v-if="columns.visible('address')" :show-overflow-tooltip="true" prop="address" label="IP来源" /> -->
      <el-table-column prop="assignee" label="处理人"/>
      <el-table-column prop="owner" label="拥有人"/>
      <el-table-column prop="processDefinitionId" label="流程定义ID"/>
      <el-table-column prop="processInstanceId" label="流程实例ID"/>
      <!-- <el-table-column prop="executionId" label="执行ID"/>-->
      <!-- <el-table-column v-if="columns.visible('address')" :show-overflow-tooltip="true" prop="address" label="IP来源" /> -->
      <el-table-column prop="startTime" label="开始时间" show-overflow-tooltip :formatter="timeColumnFormat"/>
      <el-table-column prop="endTime" label="结束时间" show-overflow-tooltip :formatter="timeColumnFormat"/>
      <el-table-column
        v-permission="['task:process']"
        label="操作"
        width="120"
        align="center"
        fixed="right"
      >
        <template slot-scope="scope">
          <el-tooltip content="流程图">
            <el-button type="text" icon="el-icon-picture"
                       permission="['instance:image']"
                       @click="viewImage(scope.row)">
            </el-button>
          </el-tooltip>
          <el-tooltip content="处理任务">
            <el-button type="text" icon="el-icon-caret-right"
                       permission="['task:process']"
                       v-if="!scope.row.endTime"
                       @click="toProcess(scope.row)">
            </el-button>
          </el-tooltip>
          <el-tooltip content="任务转出">
            <el-button type="text" icon="el-icon-top"
                       permission="['task:assignee']"
                       v-if="scope.row.assignee==user().username && !scope.row.endTime"
                       @click="toAssignee(scope.row)">
            </el-button>
          </el-tooltip>
        </template>
      </el-table-column>
    </el-table>
    <!--分页组件-->
    <el-pagination
      :page-size.sync="page.size"
      :total="page.total"
      :current-page.sync="page.page"
      style="margin-top: 8px;"
      layout="total, prev, pager, next, sizes"
      @size-change="sizeChangeHandler($event)"
      @current-change="pageChangeHandler"
    />
    <el-dialog
      append-to-body
      :close-on-click-modal="false"
      :visible.sync="showImage"
      title="流程图"
      width="90%"
    >
      <flow-image :process-instance-id="current.processInstanceId"
                  :process-definition-id="current.processDefinitionId"></flow-image>

    </el-dialog>
    <el-dialog
      append-to-body
      :close-on-click-modal="false"
      :visible.sync="startFlow"
      title="处理任务"
      width="500px"
      height="250px"
    >
      <el-form ref="form" :inline="true" :model="form" label-width="90px">
        <el-form-item v-if="isAssign" label="接收人" prop="assignee">
          <el-select v-model="form.assignee" style="width: 350px">
            <el-option v-for="item in users" :value="item.username" disabled="item.username==user().username"
                       :label="item.nickName"/>
          </el-select>
        </el-form-item>
        <el-form-item label="意见" prop="businessKey">
          <el-input type="textarea" v-model="form.comment" placeholder="请输入意见" style="width: 350px">
          </el-input>
        </el-form-item>
        <el-form-item v-if="!isAssign" label="参数" prop="parameter">
          <el-input type="textarea" v-model="form.parameter" placeholder="请输入参数(JSON)" style="width: 350px"/>
        </el-form-item>

      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button type="text" @click="startFlow=false">取消</el-button>
        <el-button type="primary" v-if="!isAssign" @click="doProcess">完成</el-button>
        <el-button type="primary" v-if="isAssign" @click="doAssignee">确定</el-button>
      </div>
    </el-dialog>
  </div>
</template>

<script>
  import { mapGetters } from 'vuex'
  import { tasks, processTask, assigneeTask, getUsers } from '../../api/workflow/activiti'
  import FlowImage from '../../components/Activiti/FlowImage'

  export default {
    name: 'Task',
    data() {
      return {
        query: { type: '1', finished: '' },
        form: { taskId: '', assignee: '', comment: '', parameter: '' },
        current: {},
        rows: [],
        loading: false,
        startFlow: false,
        isAssign: false,
        showImage: false,
        users: [],
        page: {
          // 页码
          start: 0,
          // 每页数据条数
          size: 10,
          // 总数据条数
          total: 0
        }
      }
    },
    components: { FlowImage },
    mounted() {
      this.refresh()
      getUsers({
        page: 0,
        size: 999,
        sort: 'username,desc',
        deptId: this.user().deptId,
        enabled: true
      }).then(res => {
        this.users = res.content
      })
    },
    methods: {
      refresh() {
        //console.log('==refresh======', this.currentRole())
        tasks({
            order: 'desc',
            latest: true,
            sort: 'startTime',
            size: this.page.size,
            start: this.page.start,
            finished: this.query.type == '0' ? this.query.finished : this.query.type == '3',
            taskCandidateGroup: this.query.type == '2' ? this.currentRole().id : null,
            taskAssignee: (this.query.type == '1' || this.query.type == '3') ? this.user().username : null
          }
        ).then(res => {
          //console.log(res)
          this.rows = res.data.data
          this.page.total = res.data.total
        })
      },
      viewImage(row) {
        this.current.processInstanceId = row.processInstanceId
        this.current.processDefinitionId = row.processDefinitionId
        this.showImage = true
      },
      toProcess(row) {
        this.form.taskId = row.id
        this.startFlow = true
        this.isAssign = false
      },
      toAssignee(row) {
        this.form.taskId = row.id
        this.startFlow = true
        this.isAssign = true
      },
      doProcess() {
        let parameter = {}
        if (this.form.parameter) {
          parameter = JSON.parse(this.form.parameter)
        }
        processTask(
          this.form.taskId, this.form.comment, parameter
        ).then(res => {
          if (res.code === 0) {
            this.$message.success('任务已处理')
            this.startFlow = false
            this.refresh()
          } else {
            this.$message.error(res.msg)
          }
        }).catch(error => {
          this.$message.error(error)
        })
      },
      doAssignee() {
        let parameter = {}
        if (this.form.parameter) {
          parameter = JSON.parse(this.form.parameter)
        }
        assigneeTask(
          this.form.taskId, this.form.assignee, this.form.comment, parameter
        ).then(res => {
          if (res.code === 0) {
            this.$message.success('任务已转出')
            this.startFlow = false
            this.refresh()
          } else {
            this.$message.error(res.msg)
          }
        }).catch(error => {
          this.$message.error(error)
        })
      },
      // 当前页改变
      pageChangeHandler(e) {
        this.page.start = e
        this.refresh()
      },
      // 每页条数改变
      sizeChangeHandler(e) {
        this.page.size = e
        this.page.start = 1
        this.refresh()
      },
      ...mapGetters(['currentRole', 'user'])
    }
  }
</script>

<style>
  .demo-table-expand {
    font-size: 0;
  }

  .demo-table-expand label {
    width: 70px;
    color: #99a9bf;
  }

  .demo-table-expand .el-form-item {
    margin-right: 0;
    margin-bottom: 0;
    width: 100%;
  }

  .demo-table-expand .el-form-item__content {
    font-size: 12px;
  }
</style>
