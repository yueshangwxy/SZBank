<template>
  <div class="app-container">
    <div class="head-container">
      <div>
        <el-input v-model="query.name" clearable size="small" placeholder="请输入名称" style="width: 200px;"
                  class="filter-item" @keyup.enter.native="refresh"/>
        <el-button class="filter-item" type="success" icon="el-icon-search" @click="refresh">搜索</el-button>
        <el-button class="filter-item" type="warning" icon="el-icon-plus" @click="selectBpmn=true">发布</el-button>
      </div>
    </div>
    <!--表格渲染-->
    <el-table ref="table" v-loading="loading" :data="rows" style="width: 100%;">
      <el-table-column prop="id" label="ID"/>
      <el-table-column prop="name" label="名称"/>
      <!-- <el-table-column v-if="columns.visible('address')" :show-overflow-tooltip="true" prop="address" label="IP来源" /> -->
      <el-table-column prop="category" label="分类"/>
      <el-table-column prop="deploymentTime" label="发布时间" :formatter="timeColumnFormat">
      </el-table-column>
      <el-table-column
        v-permission="['deploy:del']"
        label="操作"
        width="125"
        align="center"
        fixed="right"
      >
        <template slot-scope="scope">
          <el-button type="text" icon="el-icon-remove-outline"
                     permission="['deploy:del']"
                     @click="deleteDeploy(scope.row)">删除
          </el-button>
        </template>
      </el-table-column>
    </el-table>
    <!--分页组件-->
    <el-pagination
      :page-size.sync="page.size"
      :total="page.total"
      :current-page.sync="page.page"
      style="margin-top: 8px;"
      layout="total, prev, pager, next, sizes"
      @size-change="sizeChangeHandler($event)"
      @current-change="pageChangeHandler"
    />


    <el-dialog
      append-to-body
      :close-on-click-modal="false"
      :visible.sync="selectBpmn"
      title="选择流程文件"
      width="500px"
      height="200px"
    >
      <el-form ref="form" :inline="true" :model="form" :rules="rules" label-width="90px">
        <el-form-item label="文件名称" prop="fileName">
          <el-select v-model="form.fileName" style="width: 350px">
            <el-option v-for="item in bpmnFileNames" :value="item" :label="item"/>
          </el-select>
        </el-form-item>
        <el-form-item label="部署名称" prop="deployName">
          <el-input v-model="form.deployName" placeholder="请输入部署名称" style="width: 350px"/>
        </el-form-item>
        <el-form-item label="部署分类" prop="category">
          <el-input v-model="form.category" placeholder="请输入部署分类" style="width: 350px"/>
        </el-form-item>

      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button type="text" @click="selectBpmn=false">取消</el-button>
        <el-button type="primary" @click="publish">确认</el-button>
      </div>
    </el-dialog>
  </div>
</template>

<script>

  import { getBpmnFileNames, publishFileName, deleteDeployment, deployments } from '../../api/workflow/activiti'

  export default {
    name: 'Deployment',
    data() {
      return {
        rows: [],
        loading: false,
        selectBpmn: false,
        form: {
          fileName: '',
          deployName: '',
          category: ''
        },
        bpmnFileNames: [],
        query: {},
        page: {
          // 页码
          start: 0,
          // 每页数据条数
          size: 10,
          // 总数据条数
          total: 0
        },
        rules: {
          fileName: [
            { required: true, message: '文件名称不能为空', trigger: 'change' }
          ],
          deployName: [
            { required: true, message: '部署名称不能为空', trigger: 'blur' }
          ]
        }
      }
    },
    components: {},
    mounted() {
      this.refresh()
      getBpmnFileNames().then(res => {
        this.bpmnFileNames = res.data
      })
    },
    methods: {
      refresh() {
        deployments(Object.assign({
            order: 'desc',
            sort: 'deployTime',
            size: this.page.size,
            start: this.page.start
          }, this.query.name ? { name: this.query.name } : {})
        ).then(res => {
          //console.log(res)
          this.rows = res.data.data
          this.page.total = res.data.total
        })
      },
      publish() {
        this.$refs['form'].validate(valid => {
          if (!valid) {
            return
          }
          publishFileName(this.form.fileName, this.form.deployName, this.form.category).then(res => {
            this.$message.success('流程发布成功')
            this.selectBpmn = false
            this.refresh()
          }).catch(error => {
            this.$message.error(error)
          })
        })
      },
      deleteDeploy(row) {
        console.log('================', row)
        this.$confirm('确定要删除流程[' + row.name + ']吗？').then(() => {
          deleteDeployment(row.id).then(res => {
            this.$message.success('删除成功')
            this.refresh()
          })
        })
      },
      // 当前页改变
      pageChangeHandler(e) {
        this.page.start = e
        this.refresh()
      },
      // 每页条数改变
      sizeChangeHandler(e) {
        this.page.size = e
        this.page.start = 1
        this.refresh()
      }
    }
  }
</script>

<style scoped>
</style>
