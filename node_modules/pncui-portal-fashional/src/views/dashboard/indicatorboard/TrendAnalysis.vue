<template>
  <el-card :class="className" :style="{height:height,width:width}">
    <div slot="header" class="clearfix">
      <span class="card-title-text">存贷款趋势分析</span>
      <span class="card-title-unit">(万元)</span>
    </div>
    <div class="card-main card-main-chart card-main-trend-analysis">
      <div class="card-main card-main-chart card-main-trend-analysis" id="card-main-trend-analysis">
      </div>
      <div class="card-trend-bar">
        <el-radio-group v-model="dataType" size="mini" @change="initChart">
          <el-radio-button label="day" size="mini">日</el-radio-button>
          <el-radio-button label="month" size="mini">月</el-radio-button>
        </el-radio-group>
      </div>
    </div>
  </el-card>
</template>

<script>
  import echarts from 'echarts'
  import { mapGetters } from 'vuex'
  import { trendAnalysis } from '../../../api/dashboard/dashboard'
  import { getYesterday } from '@eladmin/utils/data_format'

  export default {
    name: 'TrendAnalysis',
    props: {
      className: {
        type: String,
        default: 'box-card'
      },
      width: {
        type: String,
        default: '100%'
      },
      height: {
        type: String,
        default: '100%'
      },
      autoResize: {
        type: Boolean,
        default: true
      },
      date: {
        type: String,
        default: getYesterday()
      }
    },
    data() {
      return {
        chart: null,
        sidebarElm: null,
        dataType: 'month',
        chartData: {}
      }
    },
    mounted() {
      trendAnalysis(this.date).then(res => {
          this.chartData = res.data
          this.initChart()
        }
      )
      window.addEventListener('resize', this.onResize)
    }
    ,
    computed: {
      ...
        mapGetters([
          'sidebar'
        ])
    }
    ,
    beforeDestroy() {
      if (!this.chart) {
        return
      }
      this.chart.dispose()
      this.chart = null
    }
    ,
    methods: {
      setOptions(data) {
        let _this = this
        this.chart.setOption({
          xAxis: {
            data: data.map(e => e.dataDate),
            boundaryGap: false,
            axisTick: {
              show: false
            },
            color: '#6E6E6E',
            axisLabel: {
              formatter: '{value}',
              textStyle: { //改变刻度字体样式
                color: '#6E6E6E'
              }
            },
            axisLine: {
              lineStyle: {
                color: '#6E6E6E',
                width: 2//这里是为了突出显示加上的
              }
            }
          },
          grid: {
            left: 20,
            right: 35,
            bottom: 20,
            top: 30,
            containLabel: true
          },
          tooltip: {
            trigger: 'axis',
            axisPointer: {
              type: 'cross'
            },
            padding: [5, 10]
          },
          yAxis: {
            axisTick: {
              show: false
            },
            axisLabel: {
              formatter: '{value}',
              textStyle: { //改变刻度字体样式
                color: '#6E6E6E'
              }
            },
            axisLine: {
              show: false
            }
          },
          legend: {
            data: ['存款', '贷款']
          },
          series: [{
            name: '存款', itemStyle: {
              normal: {
                color: '#F09937',
                lineStyle: {
                  color: '#F09937',
                  width: 2
                }
              }
            },
            smooth: false,
            type: 'line',
            data: data.map(e => e.deposit),
            animationDuration: 2800,
            animationEasing: 'cubicInOut'
          },
            {
              name: '贷款',
              smooth: false,
              type: 'line',
              itemStyle: {
                normal: {
                  color: '#489FF8',
                  lineStyle: {
                    color: '#489FF8',
                    width: 2
                  },
                  areaStyle: {
                    color: '#FFFFFF'
                  }
                }
              },
              data: data.map(e => e.loan),
              animationDuration: 2800,
              animationEasing: 'quadraticOut'
            }]
        })
      }
      ,
      onResize() {
        if (this.chart) {
          this.chart.resize()
        }
      }
      ,
      initChart(type) {
        console.log('开始绘制图表...', type)
        if (this.chart) {
          this.chart.dispose()
        }
        this.chart = echarts.init(document.querySelector('#card-main-trend-analysis'))
        if (type == 'day') {
          this.setOptions(this.chartData.day)
        } else {
          this.setOptions(this.chartData.month)
        }
      }
    }
    ,
    watch: {
      sidebar: {
        deep: true,
        immediate: true,
        handler:
          function(newValue, oldValue) {
            //console.log('=====watch>>', oldValue, newValue)
            this.onResize()
            // result为true，则表示是全部选中
          }
      }
    }
  }
</script>

<style scoped>
</style>
