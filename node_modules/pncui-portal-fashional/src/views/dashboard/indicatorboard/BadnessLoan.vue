<template>
  <el-card :class="className" :style="{height:height,width:width}">
    <div slot="header" class="clearfix">
      <span class="card-title-text">不良贷款分析</span>
      <span class="card-title-unit">(万元,%)</span>
    </div>
    <div id="card-main-badness-loan" class="card-main card-main-chart card-main-trend-analysis"/>
  </el-card>
</template>

<script>
  import echarts from 'echarts'
  import { mapGetters } from 'vuex'
  import { badnessLoan } from '../../../api/dashboard/dashboard.js'
  import { getYesterday } from '@eladmin/utils/data_format'

  export default {
    name: 'BadnessLoan',
    props: {
      className: {
        type: String,
        default: 'box-card'
      },
      width: {
        type: String,
        default: '100%'
      },
      height: {
        type: String,
        default: '100%'
      },
      autoResize: {
        type: Boolean,
        default: true
      },
      date: {
        type: String,
        default: getYesterday()
      }
    },
    data() {
      return {
        chart: null,
        sidebarElm: null,
        chartData: []
      }
    },
    mounted() {
      badnessLoan(this.date).then(res => {
          this.chartData = res.data
          this.initChart()
        }
      )
      window.addEventListener('resize', this.onResize)
    },
    computed: {
      ...
        mapGetters([
          'sidebar'
        ])
    },
    beforeDestroy() {
      if (!this.chart) {
        return
      }
      this.chart.dispose()
      this.chart = null
    },
    methods: {
      setOptions(data) {
        this.chart.setOption({
          xAxis: {
            data: data.map(e => e.dataDate),
            boundaryGap: true,
            axisTick: {
              show: false
            },
            color: '#6E6E6E',
            axisLabel: {
              formatter: '{value}',
              textStyle: { // 改变刻度字体样式
                color: '#6E6E6E'
              }
            },
            axisLine: {
              lineStyle: {
                color: '#6E6E6E',
                width: 2// 这里是为了突出显示加上的
              }
            }
          },
          grid: {
            left: 20,
            right: 20,
            bottom: 20,
            top: 30,
            containLabel: true
          },
          tooltip: {
            trigger: 'axis',
            axisPointer: {
              type: 'cross'
            },
            padding: [5, 10]
          },
          yAxis: [{
            type: 'value',
            splitNumber: 5,
            splitLine: {
              show: true,
              lineStyle: {
                // 使用深浅的间隔色
                color: ['#eee']
              }
            },
            axisTick: {
              show: false
            },
            axisLabel: {
              formatter: '{value}',
              textStyle: { // 改变刻度字体样式
                color: '#6E6E6E'
              }
            },
            axisLine: {
              show: false
            }
          }, {
            type: 'value',
            splitNumber: 5,
            splitLine: {
              show: true,
              lineStyle: {
                // 使用深浅的间隔色
                color: ['#eee']
              }
            },
            axisTick: {
              show: false
            },
            axisLabel: {
              formatter: '{value}%',
              textStyle: { // 改变刻度字体样式
                color: '#6E6E6E'
              }
            },
            axisLine: {
              show: false
            },
            interval: 0.5
          }],
          legend: {
            data: ['不良贷款率', '不良贷款余额']
          },
          series: [{
            name: '不良贷款余额',
            itemStyle: {
              normal: {
                color: '#F09937',
                lineStyle: {
                  color: '#F09937'
                  // width: 2
                }
              }
            },
            type: 'bar',
            barWidth: '30%',
            // barGap: '10%',
            data: data.map(e => e.loan),
            animationDuration: 2800,
            animationEasing: 'cubicInOut'
          },
            {
              name: '不良贷款率',
              smooth: false,
              type: 'line',
              yAxisIndex: 1,
              itemStyle: {
                normal: {
                  color: '#489FF8',
                  lineStyle: {
                    color: '#489FF8',
                    width: 2
                  }
                }
              },
              data: data.map(e => e.rate),
              animationDuration: 2800,
              animationEasing: 'quadraticOut'
            }]
        })
      },
      onResize() {
        if (this.chart) {
          this.chart.resize()
        }
      },
      initChart() {
        console.log('开始绘制图表...')
        this.chart = echarts.init(document.querySelector('#card-main-badness-loan'))
        console.log('初始化echart》', this.chart)
        this.setOptions(this.chartData)
      }
    },
    watch: {
      sidebar: {
        deep: true,
        immediate: true,
        handler:
          function(newValue, oldValue) {
            //console.log('=====watch>>', oldValue, newValue)
            this.onResize()
            // result为true，则表示是全部选中
          }
      }
    }
  }
</script>

<style scoped>
</style>
