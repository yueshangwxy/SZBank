<template>
  <el-card :class="className" :style="{height:height,width:width}">
    <div slot="header" class="clearfix">
      <span class="card-title-text">存款结构分析</span>
      <span class="card-title-unit"><span class="card-title-total">{{ $accounting.formatNumber(chartData.total,2) }}</span>(万元)</span>
    </div>
    <div id="card-main-deposit-analysis" class="card-main card-main-chart card-main-deposit-analysis" />
  </el-card>
</template>

<script>
  import echarts from 'echarts'
  import { mapGetters } from 'vuex'
  import { depositAnalysis } from '../../../api/dashboard/dashboard.js'
  import { getYesterday } from '@eladmin/utils/data_format'

  export default {
    name: 'DepositAnalysis',
    props: {
      className: {
        type: String,
        default: 'box-card'
      },
      width: {
        type: String,
        default: '100%'
      },
      height: {
        type: String,
        default: '100%'
      },
      autoResize: {
        type: Boolean,
        default: true
      },
      date: {
        type: String,
        default: getYesterday()
      }
    },
    data() {
      return {
        chart: null,
        sidebarElm: null,
        chartData: {}
      }
    },
    mounted() {
      depositAnalysis(this.date).then(res => {
          this.chartData = res.data
          this.initChart()
        }
      )
      window.addEventListener('resize', this.onResize)
    },
    computed: {
      ...
        mapGetters([
          'sidebar'
        ])
    },
    watch: {
      sidebar: {
        deep: true,
        immediate: true,
        handler:
          function(newValue, oldValue) {
            // console.log('=====watch>>', oldValue, newValue)
            this.onResize()
            // result为true，则表示是全部选中
          }
      }
    },
    beforeDestroy() {
      if (!this.chart) {
        return
      }
      this.chart.dispose()
      this.chart = null
    },
    methods: {
      setOptions({ data } = {}) {
        this.chart.setOption({
          tooltip: {
            trigger: 'item',
            formatter: function(params, ticket, callback) {
              let res = ''
              if (params.data.detail) {
                res = params.data.detail.map(e => e.name + ':' + e.value).join('<br/>')
              }
              return res
            }
          },
          legend: {
            orient: 'vertical',
            // left: 10,
            x: '75%', // 图例距离左的距离
            y: '20%', // 图例上下居中
            data: data.map(e => e.name)
          },
          color: ['#F09937', '#489FF8', '#74C8C4'],
          series: [
            {
              name: '存款结构',
              type: 'pie',
              radius: ['45%', '72%'],
              center: ['35%', '50%'],
              avoidLabelOverlap: false,
              label: {
                show: true,
                formatter: '{d}%',
                position: 'outside'
              },
              labelLine: {
                show: true
              },
              emphasis: {
                label: {
                  show: true,
                  fontSize: '15'
                }
              },
              data: data
            }
          ]
        })
      },
      onResize() {
        if (this.chart) {
          this.chart.resize()
        }
      },
      initChart() {
        console.log('开始绘制存款结构分析图表...')
        this.chart = echarts.init(document.querySelector('#card-main-deposit-analysis'))
        this.setOptions(this.chartData)
      }
    }
  }
</script>

<style scoped>
</style>
