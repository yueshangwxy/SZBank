<template>
  <div class="navbar">
    <!--    <hamburger
      id="hamburger-container"
      :is-active="sidebar.opened"
      class="hamburger-container"
      @toggleClick="toggleSideBar"
    />-->

    <!-- <breadcrumb v-if="showBreadcrumb" id="breadcrumb-container" class="breadcrumb-container"/> -->
    <logo v-if="showLogo" :collapse="true" />
    <div class="portal-header-title">
      <div class="portal-header-title-top">统一数据门户</div>
      <div class="portal-header-title-bottom">Data Facade System</div>
    </div>
    <div class="portal-header-search">
      <!-- <el-input
        style="width: 333px"
        size="small"
        prefix-icon="el-icon-search"
        v-model="searchValue"
        placeholder="请输入搜索内容"
        @input="inputChange"
        clearable
      /> -->
      <el-autocomplete
        class="inline-input"
        style="width: 333px"
        size="small"
        prefix-icon="el-icon-search"
        v-model="searchValue"
        :fetch-suggestions="querySearch"
        placeholder="请输入搜索内容"
        :trigger-on-focus="false"
        ref="autocomplete"
        @clear="setBlur()"
        @select="handleSelect"
        @input="inputChange"
        clearable
        popper-class="remoteOption"
      >
        <template slot-scope="scope">
          <el-tooltip effect="light" :content="scope.item.value">
            <span>
              <span v-if="scope.item.assetType === 'table'">
                <el-tag type="success">表</el-tag>
              </span>
              <span v-if="scope.item.assetType === 'api'">
                <el-tag type="">API</el-tag>
              </span>
              <span v-if="scope.item.assetType === 'target'">
                <el-tag type="warning">指标</el-tag>
              </span>
              <span v-if="scope.item.assetType === 'label'">
                <el-tag type="danger">标签</el-tag>
              </span>
              {{ scope.item.value }}
            </span>
          </el-tooltip>
        </template>
      </el-autocomplete>
      <el-button
        size="small"
        style="
          width: 52px;
          font-size: 14px;
          padding: 6px 12px 6px 12px;
          background: rgba(97, 189, 83, 1);
          color: #fff;
          border: none;
        "
        @click="globalSearch"
        >搜索</el-button
      >
    </div>
    <div class="right-menu">
      <template v-if="device !== 'mobile'">
        <theme-select
          id="theme"
          class="right-menu-item hover-effect"
        ></theme-select>
      </template>
      <span class="profile-picture"> <i class="el-icon-user"></i></span>
      <el-dropdown
        class="avatar-container right-menu-item hover-effect"
        trigger="click"
        style="margin: 0"
      >
        <div class="avatar-wrapper">
          <el-link style="color: #202224; text-align: right">{{
            user.nickName ? user.nickName : "张伟"
          }}</el-link>
        </div>
        <el-dropdown-menu slot="dropdown" style="top: 43px; margin: 0">
          <span style="display: block" @click="open">
            <el-dropdown-item> 退出登录 </el-dropdown-item>
          </span>
        </el-dropdown-menu>
      </el-dropdown>
    </div>
  </div>
</template>

<script>
import { mapGetters, mapState } from "vuex";
import Breadcrumb from "@eladmin/components/Breadcrumb";
import Hamburger from "@eladmin/components/Hamburger";
// import Github from '@/components/Github'
import Screenfull from "@eladmin/components/Screenfull";
import SizeSelect from "@eladmin/components/SizeSelect";
import Search from "@eladmin/components/HeaderSearch";
import Avatar from "@eladmin/assets/images/avatar.png";
import RoleSelect from "@eladmin/components/RoleSelect";
import ThemeSelect from "../../components/ThemeSelect";
import Logo from "../components/Sidebar/Logo";

export default {
  components: {
    Breadcrumb,
    Hamburger,
    Screenfull,
    SizeSelect,
    Search,
    // Github
    RoleSelect,
    ThemeSelect,
    Logo,
  },
  data() {
    return {
      Avatar: Avatar,
      dialogVisible: false,
      searchValue: "", // 搜索内容
    };
  },
  watch: {
    $route(val) {
      this.searchValue = this.$route.query.data ? this.$route.query.data : "";
    },
    searchValue(val) {
      console.log(val);
      sessionStorage.setItem("searchKeyWords", val);
    },
  },
  created() {
    // 首页搜索保持搜索内容在输入框
    this.searchValue = this.$route.query.data ? this.$route.query.data : "";
    sessionStorage.setItem("searchKeyWords", this.searchValue);
  },
  computed: {
    ...mapGetters(["sidebar", "device", "user", "baseApi"]),
    ...mapState({
      showBreadcrumb: (state) => state.settings.showBreadcrumb,
    }),
    showLogo() {
      return this.$store.state.settings.sidebarLogo;
    },
    show: {
      get() {
        return this.$store.state.settings.showSettings;
      },
      set(val) {
        this.$store.dispatch("settings/changeSetting", {
          key: "showSettings",
          value: val,
        });
      },
    },
  },
  methods: {
    setBlur() {
      this.$refs.autocomplete.activated = true;
    },
    toggleSideBar() {
      this.$store.dispatch("app/toggleSideBar");
    },
    inputChange(value) {
      this.searchValue = value;
      sessionStorage.setItem("searchKeyWords", value);
    },
    // 输入框输入联想
    // 输入框
    querySearch(queryString, cb) {
      let request = {
        page: 1,
        size: 10,
        keywords: queryString,
        suggest: true,
      };
      setTimeout(() => {
        this.$api.getListByKeywords(request).then((res) => {
          let temp = res.obj;
          let suggestion = [];
          temp.forEach((item) => {
            if (item.targetName) {
              suggestion.push({
                value: item.targetName,
                assetType: item.assetType,
              });
            } else if (item.labelName) {
              suggestion.push({
                value: item.labelName,
                assetType: item.assetType,
              });
            } else if (item.indexName) {
              suggestion.push({
                value: item.indexName,
                assetType: item.assetType,
              });
            } else if (item.tableName) {
              suggestion.push({
                value: item.tableComment
                  ? item.tableComment
                  : "" + item.tableName,
                assetType: item.assetType,
              });
            }
          });
          cb(suggestion);
        });
      }, 1000);
    },
    handleSelect(item) {
      let type;
      if (item.assetType === "table") {
        type = 1;
      } else if (item.assetType === "api") {
        type = 2;
      } else if (item.assetType === "target") {
        type = 3;
      } else if (item.assetType === "label") {
        type = 4;
      }
      this.$router.push({
        path: "/asset/searchPage/index",
        // name: 'assetSearch'
        query: {
          data: this.searchValue,
          from: "other",
          type: type,
        },
      });
    },
    // 全局搜索
    globalSearch() {
      console.log("搜索");
      this.$router.push({
        path: "/asset/searchPage/index",
        // name: 'assetSearch',
        query: {
          data: this.searchValue,
          from: "other",
        },
      });
    },
    open() {
      this.$confirm("确定注销并退出系统吗？", "提示", {
        confirmButtonText: "确定",
        cancelButtonText: "取消",
        type: "warning",
      }).then(() => {
        this.logout();
      });
    },
    logout() {
      this.$store.dispatch("LogOut").then(() => {
        location.reload();
      });
    },
  },
};
</script>

<style lang="scss" scoped>
.navbar {
  width: 100%;
  display: flex;
  position: relative;
  background: url("/../../assets/image/bg_header.png") 100% 100% no-repeat;
  // background: linear-gradient(90deg, rgba(120, 171, 67, 1) 0%, rgba(136, 191, 77, 1) 100%);
  .portal-header-title {
    left: 155px;
    top: 19px;
    width: 105px;
    height: 33px;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: flex-start;
    margin-top: 19px;
    margin-left: 24px;
    .portal-header-title-top {
      left: 0px;
      top: 0px;
      width: 96px;
      height: 22px;
      display: flex;
      color: rgba(255, 255, 255, 1);
      color: rgba(120, 171, 67, 1);
      font-size: 16px;
    }
    .portal-header-title-bottom {
      left: 0px;
      top: 22px;
      width: 105px;
      height: 11px;
      display: flex;
      color: rgba(255, 255, 255, 1);
      color: rgba(120, 171, 67, 1);
      font-size: 8px;
      white-space: nowrap;
      transform: scale(0.65);
      margin-left: -18px;
    }
  }

  .portal-header-search {
    width: 401px;
    height: 32px;
    display: flex;
    justify-content: space-between;
    margin-top: 19px;
    margin-left: 223px;
  }
  ::v-deep .el-autocomplete {
    .el-input__inner {
      border: 1px solid #61bd53;
    }
  }
  .el-input--mini .el-input__inner {
    height: 32px;
  }
  .el-input--mini .el-input__icon {
    height: 28px;
  }
  .right-menu {
    display: flex;
    align-items: center;
    height: 70px;
    position: absolute;
    right: 24px;
    .profile-picture {
      width: 30px;
      height: 30px;
      border-radius: 30px;
      margin-right: 8px;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #202224;
      font-weight: 700;
    }
  }
}
</style>
<style lang="scss">
.remoteOption {
  .el-tag {
    margin-right: 8px;
    color: #409eff;
    background-color: #ecf5ff;
    border: 1px solid #409eff;
  }
  .el-tag.el-tag--success {
    background-color: #dedaf2;
    border-color: #7e83ed;
    color: #7e83ed;
  }
  .el-tag.el-tag--warning {
    background-color: #fff8e6;
    border-color: #ffba00;
    color: #ffba00;
  }
  .el-tag.el-tag--danger {
    background-color: #dbe9f8;
    border: 1px solid #0062ff;
    color: #0062ff;
  }
}
</style>