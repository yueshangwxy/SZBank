{"remainingRequest":"D:\\code\\DataAssetPlatform\\Pncui-Ind\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\code\\DataAssetPlatform\\Pncui-Ind\\src\\views\\indicators\\manual\\index.vue?vue&type=script&lang=js&","dependencies":[{"path":"D:\\code\\DataAssetPlatform\\Pncui-Ind\\src\\views\\indicators\\manual\\index.vue","mtime":1647917138774},{"path":"D:\\code\\DataAssetPlatform\\Pncui-Ind\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1647917124586},{"path":"D:\\code\\DataAssetPlatform\\Pncui-Ind\\node_modules\\babel-loader\\lib\\index.js","mtime":1647917124178},{"path":"D:\\code\\DataAssetPlatform\\Pncui-Ind\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1647917124586},{"path":"D:\\code\\DataAssetPlatform\\Pncui-Ind\\node_modules\\vue-loader\\lib\\index.js","mtime":1647917137429}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\r\nimport indIndicatorResult, {\r\n  getData,\r\n  getDept,\r\n  importExcel,\r\n  add,\r\n  toApprove,\r\n  getCurAndFreByName,\r\n  updateApproveStatus,\r\n  findToApproveInd\r\n} from '../../../api/indicators/indIndicatorManual'\r\nimport {getResultDepts} from '@/api/indicators/indResultSubscribe'\r\nimport CRUD, {presenter, header, form, crud} from '@crud/crud'\r\nimport rrOperation from '@crud/RR.operation'\r\nimport crudOperation from '@crud/CRUD.operation'\r\nimport udOperation from '@crud/UD.operation'\r\nimport pagination from '@crud/Pagination'\r\nimport category from '../category/category'\r\nimport Treeselect from '@riophae/vue-treeselect'\r\nimport '@riophae/vue-treeselect/dist/vue-treeselect.css'\r\n\r\n// crud交由presenter持有\r\nconst defaultCrud = CRUD({\r\n  title: '指标补录',\r\n  url: indIndicatorResult.url,\r\n  sort: 'id,desc',\r\n  crudMethod: {...indIndicatorResult.method}\r\n})\r\nconst defaultForm = {\r\n  id: null,\r\n  ieId: null,\r\n  ieCode: null,\r\n  ieName: null,\r\n  ieValue: null,\r\n  status: null,\r\n  crtUserCode: null,\r\n  crtOrgCode: null,\r\n  crtDate: null,\r\n  updUserCode: null,\r\n  updOrgCode: null,\r\n  updDate: null,\r\n  currency: null,\r\n  deptNo: null,\r\n  deptName: null,\r\n  periodDate: null,\r\n  frequency: null,\r\n  supplementaryValue: null,\r\n  supplementaryReason: null,\r\n  ieKindOneCode: null,\r\n  ieKindOneName: null,\r\n  ieKindTwoName: null,\r\n  approveStatus: null,\r\n  submitDescribe: null\r\n}\r\n\r\nconst bizNames = {}\r\nconst bizFrequency = {}\r\nconst bizCurrency = {}\r\nconst deptList = []\r\nconst toApproveData = []\r\nexport default {\r\n  name: 'IndIndicatorResult',\r\n  components: {Treeselect, pagination, crudOperation, rrOperation, category, udOperation},\r\n  mixins: [presenter(defaultCrud), header(), form(defaultForm), crud()],\r\n  dicts: ['RETENTION', 'IE_TYPE', 'IE_STATUS', 'IND_CURRENCY', 'IND_FIRST_TYPE', 'BUSSINESS_DEPT', 'IE_FREQUENCY', 'IND_APPROVE_STATUS'],\r\n  data() {\r\n    return {\r\n      showDialog: false,\r\n      toApproveDialog: false,\r\n      innerVisible: false,\r\n      showLoad: true,\r\n      ids: null,\r\n      infoIds: null,\r\n      importDataText: '导入数据',\r\n      importDisabled: false,\r\n      permission: {\r\n        add: ['admin', 'indIndicatorResult:add'],\r\n        edit: ['admin', 'indIndicatorResult:edit'],\r\n        del: ['admin', 'indIndicatorResult:del']\r\n      },\r\n      readOnly: false,\r\n      bizNames,\r\n      deptList,\r\n      toApproveData,\r\n      bizFrequency,\r\n      bizCurrency,\r\n      cur_page: 1,\r\n      pageSize: 5,\r\n      pageSizes: [5, 10, 20, 30, 40, 50],\r\n      total: 0,\r\n      count: 0,\r\n      newOrEdit: true,\r\n      newRules: {\r\n        ieName: [\r\n          {required: true, message: '指标名称不能为空', trigger: 'change'}\r\n        ],\r\n        ieCode: [\r\n          {required: true, message: '指标编号不能为空', trigger: 'change'}\r\n        ],\r\n        currency: [\r\n          {required: true, message: '币种不能为空', trigger: 'change'}\r\n        ],\r\n        frequency: [\r\n          {required: true, message: '频率不能为空', trigger: 'change'}\r\n        ],\r\n        supplementaryValue: [\r\n          {required: true, message: '补录值不能为空', trigger: 'blur'}\r\n        ],\r\n        supplementaryReason: [\r\n          {required: true, message: '补录原因不能为空', trigger: 'blur'},\r\n          {max: 300, message: '补录原因不能超过300字', trigger: ['blur', 'change']}\r\n        ],\r\n        deptNo: [\r\n          {required: true, message: '业务属主机构不能为空', trigger: ['blur', 'change']}\r\n        ],\r\n        periodDate: [\r\n          {required: true, message: '数据日期不能为空', trigger: 'blur'}\r\n        ],\r\n      },\r\n      editRules: {\r\n        supplementaryValue: [\r\n          {required: true, message: '补录值不能为空', trigger: 'blur'}\r\n        ],\r\n        supplementaryReason: [\r\n          {required: true, message: '补录原因不能为空', trigger: 'blur'},\r\n          {max: 300, message: '补录原因不能超过300字', trigger: ['blur', 'change']}\r\n        ],\r\n      }\r\n    }\r\n\r\n  },\r\n  created() {\r\n    this.resetQuery()\r\n    this.getDepts()\r\n    getData().then(data => {\r\n      this.bizNames = data.data;\r\n    })\r\n  },\r\n  methods: {\r\n    resetQuery() {\r\n      this.crud.resetQuery(false);\r\n      this.crud.refresh()\r\n    },\r\n    // 获取数据前设置好接口地址\r\n    [CRUD.HOOK.beforeRefresh]() {\r\n      this.crud.optShow.del = false\r\n      this.crud.optShow.add = false\r\n      return true\r\n    },\r\n    forceUpdate(e) {\r\n      this.$forceUpdate(); //\r\n    },\r\n    inputSelect(data) {\r\n      this.$refs.form.validateField('deptNo');\r\n    },\r\n    downloadTemplate() {\r\n      //注意路径，前面不要加 ./ 会形成相对路径，点击下载不了。\r\n\r\n      const url = '/ind_indicator_result.xlsx'\r\n      const link = document.createElement('a')\r\n      link.style.display = 'none'\r\n      link.href = url\r\n      link.setAttribute(\r\n          'download',\r\n          \"指标数据补录模板\"\r\n      )\r\n      document.body.appendChild(link)\r\n      link.click();\r\n      //window.open('/指标数据补录模板.xlsx','_blank','测试')\r\n    },\r\n    handleSizeChange(val) {\r\n      this.pageSize = val;\r\n      this.cur_page = 1;\r\n    },\r\n    // 分页导航\r\n    handleCurrentChange(val) {\r\n      this.cur_page = val;\r\n      /*\r\n              this.tableData = this.allData.slice((pageNumber - 1) * pageSize, pageNumber * pageSize)\r\n      */\r\n\r\n    },\r\n\r\n    getRowKeys(row) {\r\n      return row.id;\r\n    },\r\n    selectChange() {\r\n      getCurAndFreByName(this.form.ieName).then(data =>{\r\n        this.bizFrequency =data.fre\r\n        this.bizCurrency =data.cur\r\n      })\r\n      this.form.currency =\"\"\r\n      this.form.frequency =\"\"\r\n      for (var i = 0; i < Object.keys(this.bizNames).length; i++) {\r\n        if (this.form.ieName == this.bizNames[i].bizName) {\r\n          this.form.ieCode = this.bizNames[i].bizCode\r\n          this.form.ieId = this.bizNames[i].id\r\n          this.form.ieKindOneCode = this.bizNames[i].indFirstType\r\n          this.form.ieKindOneName = this.bizNames[i].indFirstTypeName\r\n          this.form.ieKindTwoCode = this.bizNames[i].indSecondType\r\n          this.form.ieKindTwoName = this.bizNames[i].indSecondTypeName\r\n          // this.form.frequency = this.bizNames[i].indFrequency\r\n        }\r\n      }\r\n    },\r\n\r\n    addOrEdit(data) {\r\n\r\n      if (data.length > 0) {\r\n        this.newOrEdit = false\r\n        this.form.id = data[0].id\r\n        this.form.ieName = data[0].ieName\r\n        this.form.ieCode = data[0].ieCode\r\n        this.form.frequency = data[0].frequency\r\n        this.form.deptNo = data[0].deptNo == 'undefined' ? null : data[0].deptNo\r\n        this.form.deptName = data[0].deptName\r\n        this.form.periodDate = data[0].periodDate\r\n        this.form.currency = data[0].currency\r\n        this.form.supplementaryValue = data[0].supplementaryValue\r\n        this.form.supplementaryReason = data[0].supplementaryReason\r\n        this.form.approveStatus = data[0].approveStatus\r\n        this.form.ieKindOneCode = data[0].ieKindOneCode\r\n        this.form.ieKindOneName = data[0].ieKindOneName\r\n        this.form.ieKindTwoCode = data[0].ieKindTwoCode\r\n        this.form.ieKindTwoName = data[0].ieKindTwoName\r\n        this.readOnly = true\r\n        if (this.form.approveStatus == \"1\") {\r\n          this.$message({\r\n            message: '审批中的指标信息不可更改',\r\n            type: 'warning'\r\n          });\r\n        } else {\r\n          this.showDialog = true;\r\n        }\r\n      } else {\r\n        this.form.deptNo = null;\r\n\r\n        this.showDialog = true;\r\n      }\r\n\r\n    },\r\n    toEdit(cloumn) {\r\n      if (cloumn.approveStatus == \"1\") {\r\n        this.$message({\r\n          message: '审批中的指标信息不可更改',\r\n          type: 'warning'\r\n        });\r\n      } else {\r\n        getCurAndFreByName('').then(data =>{\r\n          this.bizFrequency =data.fre\r\n          this.bizCurrency =data.cur\r\n        })\r\n        this.newOrEdit = false\r\n        this.form.id = cloumn.id\r\n        this.form.ieName = cloumn.ieName\r\n        this.form.ieCode = cloumn.ieCode\r\n        this.form.frequency = cloumn.frequency\r\n        this.form.deptNo = cloumn.deptNo\r\n        this.form.deptName = cloumn.deptName\r\n        this.form.periodDate = cloumn.periodDate\r\n        this.form.currency = cloumn.currency\r\n        this.form.supplementaryValue = cloumn.supplementaryValue\r\n        this.form.supplementaryReason = cloumn.supplementaryReason\r\n        this.readOnly = true\r\n        this.showDialog = true;\r\n      }\r\n    },\r\n    submitCU() {\r\n      this.$refs['form'].validate(valid => {\r\n        if (!valid) {\r\n          return;\r\n        } else {\r\n          add(this.form).then(data => {\r\n            if (data.code === 0) {\r\n              this.$message.success({\r\n                message: '操作成功!'\r\n              })\r\n              this.closeFlowDialog();\r\n              this.crud.toQuery();\r\n            } else {\r\n              this.$message.error({\r\n                message: data.msg\r\n              })\r\n              this.closeFlowDialog();\r\n              this.crud.toQuery();\r\n            }\r\n          })\r\n        }\r\n\r\n      })\r\n\r\n    },\r\n\r\n    closeFlowDialog() {\r\n\r\n      this.form.id = \"\";\r\n      this.form.ieName = \"\";\r\n      this.form.ieCode = \"\";\r\n      this.form.frequency = \"\";\r\n      this.form.deptNo = null;\r\n      this.form.deptName = null;\r\n      this.form.periodDate = \"\";\r\n      this.form.currency = \"\";\r\n      this.form.supplementaryValue = \"\";\r\n      this.form.supplementaryReason = \"\";\r\n      //this.crud.selections = [];\r\n      this.$nextTick(() => {\r\n        this.$refs.form.resetFields();\r\n      })\r\n      this.newOrEdit = true\r\n      this.readOnly = false\r\n      this.crud.toQuery();\r\n      this.showDialog = false;\r\n      getCurAndFreByName('').then(data =>{\r\n        this.bizFrequency =data.fre\r\n        this.bizCurrency =data.cur\r\n      })\r\n    },\r\n    showApproveDialog() {\r\n      this.toApproveDialog = true;\r\n      this.$refs.table.clearSelection();\r\n      findToApproveInd().then(data => {\r\n        this.toApproveData = data.data\r\n        this.total = this.toApproveData.length\r\n        this.count = parseInt(this.total) / parseInt(this.pageSize);\r\n        this.count = Math.ceil(this.count);\r\n        this.showLoad = false;\r\n      })\r\n    },\r\n    closeToApproveDialog() {\r\n      this.toApproveDialog = false;\r\n      this.showLoad = true;\r\n      this.cur_page = 1;\r\n      this.$refs.toApproveData.clearSelection()\r\n      this.crud.toQuery();\r\n    },\r\n    toApprove(data) {\r\n      this.ids = \"\";\r\n      this.infoIds = \"\";\r\n      for (var i = 0; i < Object.keys(data).length; i++) {\r\n        this.ids += data[i].id + \",\";\r\n      }\r\n      for (var i = 0; i < Object.keys(data).length; i++) {\r\n        this.infoIds += data[i].infoId + \",\";\r\n      }\r\n      this.ids = this.ids.substring(0, this.ids.lastIndexOf(\",\"));\r\n      this.infoIds = this.infoIds.substring(0, this.infoIds.lastIndexOf(\",\"));\r\n      this.innerVisible = true;\r\n\r\n    },\r\n    closeSubmitDialog() {\r\n      this.innerVisible = false;\r\n      this.form.submitDescribe = \"\";\r\n    },\r\n    submit() {\r\n      updateApproveStatus(this.ids, this.infoIds, this.form.submitDescribe).then(data => {\r\n        if (data.msg == \"成功\" || data.msg == \"操作成功\") {\r\n          this.$message.success({\r\n            message: '操作成功!'\r\n          })\r\n          this.closeSubmitDialog();\r\n          this.closeToApproveDialog();\r\n        } else {\r\n          this.$message.error({\r\n            message: data.msg\r\n          })\r\n        }\r\n      })\r\n\r\n    },\r\n    valueChange(e) {\r\n      this.form.supplementaryValue = e.target.value\r\n    },\r\n    beforeUpload(file) {\r\n      var FileExt = file.name.replace(/.+\\./, \"\");\r\n      if ([\"xls\", \"xlsx\"].indexOf(FileExt.toLowerCase()) === -1) {\r\n        this.$message({\r\n          type: \"warning\",\r\n          message: \"请上传后缀名为xls、xlsx的附件！\"\r\n        });\r\n        return false;\r\n      }\r\n      this.importDataText = '正在导入';\r\n      this.importDisabled = true;\r\n    },\r\n    handleSuccess() {\r\n      this.importDataText = '导入数据';\r\n      this.importDisabled = false;\r\n      this.$refs.upload.clearFiles();\r\n      this.crud.toQuery();\r\n\r\n    },\r\n    // 自定义上传 导入数据\r\n    uploadFile: function (item) {\r\n      const $this = this\r\n      let errorMsg = [];\r\n      const h = this.$createElement;\r\n      this.isImported = true;\r\n      const formData = new FormData();\r\n      formData.append(\"file\", item.file);\r\n      importExcel(formData).then(data => {\r\n\r\n        if (data.msg == \"成功\" || data.msg == \"操作成功\") {\r\n          $this.$message({\r\n            showClose: true,\r\n            type: 'success',\r\n            message: '导入成功 ',\r\n          })\r\n          this.handleSuccess();\r\n        } else {\r\n          for (let i in data.msg) {\r\n            errorMsg.push(h('p', null, data.msg[i]))\r\n          }\r\n          $this.$message({\r\n            showClose: true,\r\n            duration: 0,\r\n            type: 'error',\r\n            message: h('div', null, errorMsg)\r\n          })\r\n          this.handleSuccess();\r\n        }\r\n      })\r\n    },\r\n    getDepts() {\r\n      getResultDepts().then(res => {\r\n        this.deptList = res.content\r\n      })\r\n    },\r\n  },\r\n\r\n  mounted() {\r\n    // this.getDepts()\r\n    getCurAndFreByName('').then(data =>{\r\n      this.bizFrequency =data.fre\r\n      this.bizCurrency =data.cur\r\n    })\r\n\r\n  },\r\n  computed: {\r\n    rules: function () {\r\n      if (this.newOrEdit) {\r\n        return this.newRules\r\n      } else {\r\n        return this.editRules\r\n      }\r\n    }\r\n  }\r\n\r\n}\r\n",null]}