{"remainingRequest":"C:\\Users\\Evicce\\Desktop\\工作\\code2\\indicator\\Pncui-Indicator\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!C:\\Users\\Evicce\\Desktop\\工作\\code2\\indicator\\Pncui-Indicator\\src\\views\\indicators\\indicator\\approve.vue?vue&type=script&lang=js&","dependencies":[{"path":"C:\\Users\\Evicce\\Desktop\\工作\\code2\\indicator\\Pncui-Indicator\\src\\views\\indicators\\indicator\\approve.vue","mtime":1644369310590},{"path":"C:\\Users\\Evicce\\Desktop\\工作\\code2\\indicator\\Pncui-Indicator\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\Evicce\\Desktop\\工作\\code2\\indicator\\Pncui-Indicator\\node_modules\\babel-loader\\lib\\index.js","mtime":315532800000},{"path":"C:\\Users\\Evicce\\Desktop\\工作\\code2\\indicator\\Pncui-Indicator\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\Evicce\\Desktop\\工作\\code2\\indicator\\Pncui-Indicator\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport crudIndIndicatorInfo, { getIndDeriveRuleByIeCode, updateStatus, getIndBaseRule, getIndDeriveRule } from '../../../api/indicators/indIndicatorInfo'\nimport CRUD, { presenter, header, form, crud } from '@crud/crud'\nimport rrOperation from '@crud/RR.operation'\nimport crudOperation from '@crud/ACRUD.operation'\nimport udOperation from '@crud/UD.operation'\nimport pagination from '@crud/Pagination'\nimport checkApproves from './approve/checkApproves'\nimport checkApprove from './approve/checkApprove'\nimport lookDetails from './details/lookApproveDetails'\nimport { getDepts } from '@system/api/system/dept'\n\n// crud交由presenter持有\nconst defaultCrud = CRUD({ title: '指标基本信息', url: crudIndIndicatorInfo.url, sort: 'id,desc', crudMethod: { ...crudIndIndicatorInfo.method }})\nexport default {\n  name: 'IndIndicatorInfo',\n  components: {\n    pagination, crudOperation, rrOperation, udOperation, checkApproves, checkApprove, lookDetails },\n  mixins: [presenter(defaultCrud), header(), crud()],\n  dicts: ['IE_PROP', 'IE_TYPE', 'IE_METHOD', 'CALC_FREQ', 'IE_STATUS', 'IE_DATA_UNIT', 'RETENTION', 'BUTTON_NAME'],\n  data() {\n    return {\n      table: {\n\n        columns: {\n          id: 'hidden'\n          /* crtOrgCode: 'hidden',\n          updOrgCode: 'hidden',*/\n        }\n      },\n      permission: {\n        upLine: ['admin', 'baseIndIndicatorInfo:upLine'],\n        startUsing: ['admin', 'baseIndIndicatorInfo:startUsing'],\n        add: ['admin', 'indIndicatorInfo:add'],\n        edit: ['admin', 'indIndicatorInfo:edit'],\n        del: ['admin', 'indIndicatorInfo:del']\n      }\n    }\n  },\n  methods: {\n    // 获取数据前设置好接口地址\n    [CRUD.HOOK.beforeRefresh]() {\n      /* this.query.status = this.$route.query.status,*/\n      this.query.queryType = '2'\n      return true\n    },\n    // 单条条数据审批\n    approve(row) {\n      const ieCodes = []\n      const _this = this.$refs.checkApprove\n      // 打开审批页面时通过ieCode去查询取值规则\n      const indDeriveRule = {\n        ieCode: row.ieCode\n      }\n      ieCodes.push(row.ieCode)\n\n      if (row.status == 2) {\n        // 开发校验通过后执行审批\n        // 基础指标验证\n        if (row.ieType == 1) {\n          getIndBaseRule(ieCodes).then(returnData => {\n            if (returnData.code !== 0) {\n              this.crud.notify(returnData.msg + '指标未进行开发', CRUD.NOTIFICATION_TYPE.ERROR)\n            } else {\n             /* getIndDeriveRuleByIeCode(indDeriveRule).then(data => {\n                if (data.code === 0) {\n                  _this.$set(_this.form, 'calcRule', data.data.ruleDesc)\n                }\n              })*/\n              getDepts({ enabled: true }).then(res => {\n                _this.depts = res.content\n              })\n              _this.title = '审批'\n              _this.form = row\n              _this.approveDialog = true\n            }\n          })\n        }\n        // 衍生指标 验证是否可以上线\n        if (row.ieType == 2) {\n          getIndDeriveRule(ieCodes).then(returnData => {\n            if (returnData.code !== 0) {\n              this.crud.notify(returnData.msg + '指标未进行开发', CRUD.NOTIFICATION_TYPE.ERROR)\n            } else {\n              /* getIndDeriveRuleByIeCode(indDeriveRule).then(data => {\n                if (data.code === 0) {\n                  _this.$set(_this.form, 'calcRule', data.data.ruleDesc)\n                }\n              })*/\n              getDepts({ enabled: true }).then(res => {\n                _this.depts = res.content\n              })\n              _this.title = '审批'\n              _this.form = row\n              _this.approveDialog = true\n            }\n          })\n        }\n      } else {\n        /* getIndDeriveRuleByIeCode(indDeriveRule).then(data => {\n          if (data.code === 0) {\n            _this.$set(_this.form, 'calcRule', data.data.ruleDesc)\n          }\n        })*/\n        getDepts({ enabled: true }).then(res => {\n          _this.depts = res.content\n        })\n        _this.title = '审批'\n        _this.form = row\n        _this.approveDialog = true\n      }\n    },\n    /* 点击上线按钮触发事件 */\n    upLine(data) {\n      let temp = 0\n      const param = []\n      const ieCodes = []\n      for (let i = 0; i < data.length; i++) {\n        // 状态校验-只能选择0-已审批\n        if (data[i].status != 2) {\n          temp = -1\n          break\n        }\n        const indIndicatorInfo = {\n          'id': data[i].id,\n          'status': '4'\n        }\n        param.push(indIndicatorInfo)\n        ieCodes.push(data[i].ieCode)\n      }\n      if (temp == -1) {\n        this.crud.notify('请选择已审批的数据', CRUD.NOTIFICATION_TYPE.ERROR)\n        return false\n      }\n      // 开发校验通过后执行审批\n\n      getIndBaseRule(ieCodes).then(returnData => {\n        if (returnData.code !== 0) {\n          this.crud.notify(returnData.msg + '指标未进行开发', CRUD.NOTIFICATION_TYPE.ERROR)\n        } else {\n          this.$confirm(`确定上线所选数据吗?`, '提示', {\n            confirmButtonText: '确定',\n            cancelButtonText: '取消',\n            type: 'warning'\n          }).then(() => {\n            // 开发校验通过后,修改状态\n            updateStatus(param).then(returnData => {\n              if (returnData.code === 0) {\n                this.crud.notify('操作成功', CRUD.NOTIFICATION_TYPE.SUCCESS)\n                this.crud.toQuery()\n              } else {\n                this.crud.notify('操作失败!错误原因:' + returnData.msg, CRUD.NOTIFICATION_TYPE.ERROR)\n                this.crud.toQuery()\n              }\n            })\n          })\n        }\n      })\n    },\n    // 启用按钮\n    startUsing(data) {\n      let temp = 0\n      const param = []\n      for (let i = 0; i < data.length; i++) {\n        // 状态校验-只能选择4-已上线，不能啟用6-停用的数据\n        if (data[i].status != 4) {\n          temp = -1\n          break\n        }\n        const indIndicatorInfo = {\n          'id': data[i].id,\n          'status': '5'\n        }\n        param.push(indIndicatorInfo)\n      }\n      if (temp == -1) {\n        this.crud.notify('请选择已上线的数据', CRUD.NOTIFICATION_TYPE.ERROR)\n        return false\n      }\n      this.$confirm(`确定启用所选数据吗?`, '提示', {\n        confirmButtonText: '确定',\n        cancelButtonText: '取消',\n        type: 'warning'\n      }).then(() => {\n        updateStatus(param).then(returnData => {\n          if (returnData.code === 0) {\n            this.crud.notify('操作成功', CRUD.NOTIFICATION_TYPE.SUCCESS)\n            this.crud.toQuery()\n          } else {\n            this.crud.notify('操作失败!错误原因:' + returnData.msg, CRUD.NOTIFICATION_TYPE.ERROR)\n            this.crud.toQuery()\n          }\n        })\n      })\n    },\n    // 多条数据审批\n    approves(data) {\n      let temp = 0\n      const ieCodes = []\n      const _this = this.$refs.checkApproves\n      _this.title = '审批'\n\n      for (let i = 0; i < data.length; i++) {\n        const indIndicatorInfo = {\n          'id': data[i].id\n        }\n       for (let j = 0; j < data.length; j++) {\n         if (data[i].status != data[j].status) {\n            temp = -1\n         }\n       }\n\n        _this.param.push(indIndicatorInfo)\n        ieCodes.push(data[i].ieCode)\n      }\n      if (temp == -1) {\n        this.crud.notify('请选择状态一致的数据', CRUD.NOTIFICATION_TYPE.ERROR)\n        _this.approveDialog = false\n        return false\n      } else {\n        if (data[0].status == 2) {\n          // 判断是否已开发具备上线\n          // 判断是基础指标1 还是 衍生指标2\n          if (data[0].ieType == 1) {\n            getIndBaseRule(ieCodes).then(returnData => {\n              if (returnData.code !== 0) {\n                this.crud.notify(returnData.msg + '指标未进行开发', CRUD.NOTIFICATION_TYPE.ERROR)\n                _this.approveDialog = false\n              } else {\n                _this.approveDialog = true\n              }\n            })\n          }\n          if (data[0].ieType == 2) {\n            // 开发校验通过后执行审批\n            getIndDeriveRule(ieCodes).then(returnData => {\n              if (returnData.code !== 0) {\n                this.crud.notify(returnData.msg + '指标未进行开发', CRUD.NOTIFICATION_TYPE.ERROR)\n                _this.approveDialog = false\n              } else {\n                _this.approveDialog = true\n              }\n            })\n          }\n        } else {\n          _this.approveDialog = true\n        }\n      }\n\n      _this.form.status = data[0].status\n    },\n    details(row) {\n      const _this = this.$refs.lookDetails\n      // 打开详情页面时通过ieCode去查询取值规则\n      const indDeriveRule = {\n        ieCode: row.ieCode\n      }\n      getIndDeriveRuleByIeCode(indDeriveRule).then(data => {\n        if (data.code === 0) {\n          _this.$set(_this.form, 'calcRule', data.data.ruleDesc)\n        }\n      })\n      getDepts({ enabled: true }).then(res => {\n        _this.depts = res.content\n      })\n      _this.title = '详情'\n      _this.form = row\n      _this.detailsDialog = true\n    }\n  }\n}\n",null]}