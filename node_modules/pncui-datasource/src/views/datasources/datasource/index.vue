<template>
  <div class="app-container">
    <!--工具栏-->
    <div class="head-container">
      <div>
        <span v-if="crud.props.searchToggle">
          <!-- 搜索 -->
          <el-input v-model="query.datasourceName" clearable size="small" placeholder="数据源名称" style="width: 150px;"
                    class="filter-item" @keyup.enter.native="crud.toQuery"/>
          <el-select v-model="query.datasourceType" clearable size="small" placeholder="数据库类型" class="filter-item"
                     style="width: 150px" @change="crud.toQuery">
            <el-option v-for="item in dict.DATASOURCE_TYPE" :key="item.id" :label="item.label" :value="item.value"/>
          </el-select>
          <rrOperation :crud="crud"/>
        </span>
        <!--如果想在工具栏加入更多按钮，可以使用插槽方式， slot = 'left' or 'right'-->
        <crudOperation style="margin-left: 9px" :permission="permission"></crudOperation>
      </div>

<!--        <el-button
            slot="right"
            v-permission="permission.dataBaseManage"
            class="filter-item"
            size="mini"
            type="info"
            title="不选择时维护系统数据源"
            icon="el-icon-setting"
            :disabled="crud.selections.length > 1"
            @click="dataBaseManage(crud.selections[0],crud.selections.length)"
        >
          数据库管理
        </el-button>-->

      <!--表单组件-->
      <el-dialog :close-on-click-modal="false" :before-close="crud.cancelCU" :visible.sync="crud.status.cu > 0"
                 :title="crud.status.title" width="60%">
        <el-form ref="form" :model="form" :rules="rules" size="small" label-width="150px">
          <el-row>
            <el-col :span="12">
              <el-form-item label="数据源名称" prop="datasourceName">
                <el-input v-model="form.datasourceName" style="width: 100%;"/>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="数据库源型" prop="datasourceType">
                <el-select v-model="form.datasourceType" clearable placeholder="请选择" style="width: 100%;"
                           @change="setDriverType">
                  <el-option
                      v-for="item in dict.DATASOURCE_TYPE"
                      :key="item.id"
                      :label="item.label"
                      :value="item.value"
                  />
                </el-select>
              </el-form-item>
            </el-col>
          </el-row>
         <el-row>
           <!--  <el-col :span="12">
              <el-form-item label="数据库驱动类型">
                <el-select v-model="form.datasourceDriverType" clearable placeholder="请选择" style="width: 100%;"
                           @change="setDriver">
                  <el-option
                      v-for="item in dict.DATASOURCE_TYPE"
                      :key="item.id"
                      :label="item.label"
                      :value="item.value"
                  />
                </el-select>
              </el-form-item>
            </el-col>-->
            <el-col :span="12">
              <el-form-item label="数据库驱动" prop="datasourceDriver">
                <el-input v-model="form.datasourceDriver" style="width: 100%;"/>
              </el-form-item>
            </el-col>
           <el-col :span="12">
             <el-form-item label="数据库SCHEMA" prop="datasourceSchema">
               <el-input v-model="form.datasourceSchema" style="width: 100%;"/>
             </el-form-item>
           </el-col>
          </el-row>
          <el-row>

              <el-form-item label="描述">
                <el-input v-model="form.datasourceDesc" style="width: 100%;"/>
              </el-form-item>
          </el-row>
          <el-row>
            <el-form-item label="连接URL" prop="datasourceUrl">
              <el-input type="textarea" :rows="2" v-model="form.datasourceUrl" style="width: 100%;"/>
            </el-form-item>
          </el-row>
          <el-row>
            <el-col :span="12">
              <el-form-item label="用户名" prop="datasourceUser">
                <el-input v-model="form.datasourceUser" style="width: 100%;"/>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="密码" prop="datasourcePassword">
                <el-input v-model="form.datasourcePassword" :type="passw" style="width: 100%;">
                  <i slot="suffix" :class="icon" @click="showPass"/>
                </el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <!--<el-form-item label="创建用户">
            <el-input v-model="form.crtUserCode" style="width: 100%;" />
          </el-form-item>
          <el-form-item label="创建机构">
            <el-input v-model="form.crtOrgCode" style="width: 100%;" />
          </el-form-item>
          <el-form-item label="创建时间">
            <el-input v-model="form.crtDate" style="width: 100%;" />
          </el-form-item>
          <el-form-item label="修改用户">
            <el-input v-model="form.updUserCode" style="width: 100%;" />
          </el-form-item>
          <el-form-item label="修改机构">
            <el-input v-model="form.updOrgCode" style="width: 100%;" />
          </el-form-item>
          <el-form-item label="修改时间">
            <el-input v-model="form.updDate" style="width: 100%;" />
          </el-form-item>-->
          <!--<el-form-item label="租户">
            <el-input v-model="form.tenant" style="width: 100%;" />
          </el-form-item>-->
          <el-row>
            <el-col :span="12">
              <el-button :type="showType" round size="mini" @click="showInfo(show)">{{ buttonName }}</el-button>
            </el-col>
            <el-col :span="12">
              <el-form-item v-if="show" label="最大连接数">
                <el-input v-model="form.maxConnNum" style="width: 100%;" on-input="value=value.replace(/[^\d]/g,'')"
                          max-length="10"/>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12">
              <el-form-item v-if="show" label="验证方式">
                <el-select v-model="form.vallidationMethod" style="width: 100%;">
                  <el-option label="获取连接时测试" value="0"/>
                  <el-option label="返还时测试" value="1"/>
                  <el-option label="获取、返还连接时测试" value="2"/>
                  <el-option label="返还时关闭连接" value="3"/>
                  <el-option label="不测试连接" value="4"/>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item v-if="show" label="验证SQL">
                <el-input v-model="form.vallidationSql" style="width: 100%;"/>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12">
              <el-form-item v-if="show" label="源字符集">
                <el-select v-model="form.dbCharset" style="width: 100%;">
                  <el-option label="GBK" value="GBK"/>
                  <el-option label="GB2312" value="GB2312"/>
                  <el-option label="ISO-8859-1" value="ISO-8859-1"/>
                  <el-option label="UTF-8" value="UTF-8"/>
                  <el-option label="UTF-16" value="UTF-16"/>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item v-if="show" label="目标字符集">
                <el-select v-model="form.dbToCharset" style="width: 100%;">
                  <el-option label="GBK" value="GBK"/>
                  <el-option label="GB2312" value="GB2312"/>
                  <el-option label="ISO-8859-1" value="ISO-8859-1"/>
                  <el-option label="UTF-8" value="UTF-8"/>
                  <el-option label="UTF-16" value="UTF-16"/>
                </el-select>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12">
              <el-form-item v-if="show" label="引用标识符">
                <el-input v-model="form.quoteString" style="width: 100%;"/>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item v-if="show" label="事务隔离级别">
                <el-select v-model="form.transitionIsolation" style="width: 100%;">
                  <el-option label="JDBC默认值" value="0"/>
                  <el-option label="关闭事务" value="1"/>
                  <el-option label="脏数据读" value="2"/>
                  <el-option label="防止脏数据读" value="3"/>
                  <el-option label="可重复读" value="4"/>
                  <el-option label="串行" value="5"/>
                </el-select>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
        <div slot="footer" class="dialog-footer">
          <el-button type="success" plain round @click="crud.cancelCU">取消</el-button>
          <el-button :loading="crud.cu === 2" type="success" round @click="crud.submitCU">确认</el-button>
          <el-button type="success" round style="background:#67C23A" @click="doTest">测试</el-button>
        </div>
      </el-dialog>
      <!--查看详情弹出框-->
      <el-dialog :close-on-click-modal="false" title="数据源信息" :visible.sync="showDataInfo" width="60%">
        <el-form ref="form" :model="form" size="small" label-width="150px">
          <el-row>
            <el-col :span="12">
              <el-form-item label="数据源名称" prop="datasourceName">
                <el-input v-model="form.datasourceName" style="width: 100%;" :disabled="true"/>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="数据库类型" prop="datasourceType">
                <el-input v-model="form.datasourceType" style="width: 100%;" :disabled="true"/>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12">
              <el-form-item label="数据库驱动类型" prop="datasourceDriverType">
                <el-input v-model="form.datasourceDriverType" style="width: 100%;" :disabled="true"/>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="数据库驱动" prop="datasourceDriver">
                <el-input v-model="form.datasourceDriver" style="width: 100%;" :disabled="true"/>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12">
              <el-form-item label="数据库SCHEMA" prop="datasourceSchema">
                <el-input v-model="form.datasourceSchema" style="width: 100%;" :disabled="true"/>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="描述" prop="datasourceDesc">
                <el-input v-model="form.datasourceDesc" style="width: 100%;" :disabled="true"/>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-form-item label="连接URL" prop="datasourceUrl">
              <el-input type="textarea" :rows="2" v-model="form.datasourceUrl" style="width: 100%;" :disabled="true"/>
            </el-form-item>
          </el-row>
          <el-row>
            <el-col :span="12">
              <el-form-item label="用户名" prop="datasourceUser">
                <el-input v-model="form.datasourceUser" style="width: 100%;" :disabled="true"/>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="密码" prop="datasourcePassword">
                <el-input type="password" v-model="form.datasourcePassword" style="width: 100%;" :disabled="true"/>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12">
              <el-form-item label="最大连接数" prop="maxConnNum">
                <el-input v-model="form.maxConnNum" style="width: 100%;" :disabled="true"/>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="验证方式" prop="vallidationMethod">
                <el-input v-model="form.vallidationMethod" style="width: 100%;" :disabled="true"/>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12">
              <el-form-item label="验证SQL" prop="vallidationSql">
                <el-input v-model="form.vallidationSql" style="width: 100%;" :disabled="true"/>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="源字符集" prop="dbCharset">
                <el-input v-model="form.dbCharset" style="width: 100%;" :disabled="true"/>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12">
              <el-form-item label="目标字符集" prop="dbToCharset">
                <el-input v-model="form.dbToCharset" style="width: 100%;" :disabled="true"/>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="引用标识符" prop="quoteString">
                <el-input v-model="form.quoteString" style="width: 100%;" :disabled="true"/>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12">
              <el-form-item label="事务隔离级别" prop="transitionIsolation">
                <el-input v-model="form.transitionIsolation" style="width: 100%;" :disabled="true"/>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="创建用户" prop="crtUserCode">
                <el-input v-model="form.crtUserCode" style="width: 100%;" :disabled="true"/>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12">
              <el-form-item label="创建机构" prop="crtOrgCode">
                <el-input v-model="form.crtOrgCode" style="width: 100%;" :disabled="true"/>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="创建时间" prop="crtDate">
                <el-input v-model="form.crtDate" style="width: 100%;" :disabled="true"/>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12">
              <el-form-item label="修改人" prop="updUserCode">
                <el-input v-model="form.updUserCode" style="width: 100%;" :disabled="true"/>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="修改机构" prop="updOrgCode">
                <el-input v-model="form.updOrgCode" style="width: 100%;" :disabled="true"/>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12">
              <el-form-item label="修改日期" prop="updDate">
                <el-input v-model="form.updDate" style="width: 100%;" :disabled="true"/>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="租户" prop="tenant">
                <el-input v-model="form.tenant" style="width: 100%;" :disabled="true"/>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
        <div slot="footer" class="dialog-footer">
          <el-button type="text" @click="showDataInfo = false">取消</el-button>
        </div>
      </el-dialog>
      <!-- 列信息设置 -->
      <el-dialog :close-on-click-modal="false" title="列信息编辑" :visible.sync="showColumnInfo" width="50%">
        <div class="tableDiv">
          <el-table ref="multipleTable" :data="columnData" border height="450" style="width:100%;margin-top: 0px;"
                    @select="selectColumn" @select-all="selectAllColumn">
            <el-table-column label-class-name="selectionInfo" type="selection" width="100"/>
            <el-table-column label="列名称" min-width="1" prop="columnName"/>
            <el-table-column label="列描述" min-width="1" prop="columnDesc">
              <template slot-scope="scope">
                <span v-if="false">{{ scope.row.columnDesc }}</span>
                <span v-else><el-input v-model="scope.row.columnDesc" style="width:170px"></el-input></span>
              </template>
            </el-table-column>
          </el-table>
        </div>
        <div slot="footer" class="dialog-footer">
          <el-button type="success" plain round @click="showColumnInfo = false">取消</el-button>
          <el-button type="success" round @click="saveColumnInfo">保存</el-button>
        </div>
      </el-dialog>
      <!-- 数据库管理设置 -->
      <el-dialog :close-on-click-modal="false" append-to-body title="数据库管理" :visible.sync="showTable" width="80%">
        <div>
          <el-input v-model="tabName" placeholder="表名称" style="width: 10%;height: 15px"/>
          <el-button type="success" icon="el-icon-search" @click="searchName">搜索</el-button>
        </div>
        <div class="tableDiv">
          <div class="leftTable">
            <el-table v-loading="loading" :data="tableData" border height="450" style="width:100%;margin-top: 0px;"
                      @select="select" @select-all="selectAll">
              <el-table-column label-class-name="selectionInfo" type="selection" width="70"/>
              <el-table-column label="表名称" min-width="5" prop="tableName"/>
              <el-table-column label="表描述" min-width="6" prop="tableDesc"/>
            </el-table>
          </div>
          <div class="buttonDiv">
            <div class="left-footer">
              <el-button type="primary" @click="selectLeft">→</el-button>
            </div>
            <div class="right-footer">
              <el-button type="primary" @click="selectRight">←</el-button>
            </div>
          </div>
          <div class="rightTable">
            <el-table :data="resultData" border height="450" style="width:100%;margin-top: 0px;" @select="select"
                      @select-all="selectRightAll">
              <el-table-column label-class-name="selectionInfo" type="selection" width="70"/>
              <el-table-column label="表名称" min-width="5" prop="tableName"/>
              <el-table-column label="表描述" min-width="6" prop="tableDesc">
                <template slot-scope="scope">
                  <span v-if="false">{{ scope.row.tableDesc }}</span>
                  <span v-else><el-input v-model="scope.row.tableDesc" style="width:170px"></el-input></span>
                </template>
              </el-table-column>
              <el-table-column label="操作" width="70">
                <template slot-scope="scope">
                  <el-button
                      size="mini"
                      type="success"
                      icon="el-icon-edit"
                      @click="handleColumn(scope.row)"
                  />
                </template>
              </el-table-column>
            </el-table>
          </div>
        </div>
        <div class="dialog-footer">
          <el-button type="success" plain round @click="showTable = false">取 消</el-button>
          <el-button type="success" round @click="save">保存</el-button>
        </div>
      </el-dialog>
      <!--表格渲染-->
      <el-table height="540" ref="table" v-loading="crud.loading" :data="crud.data" size="small" style="width: 100%;"
                @selection-change="crud.selectionChangeHandler">
        <el-table-column type="selection" width="55"/>
        <el-table-column v-if="columns.visible('datasourceName')" prop="datasourceName" label="数据源名称" width="120"/>
        <el-table-column v-if="columns.visible('datasourceType')" prop="datasourceType" label="数据库类型">
          <template slot-scope="scope">
            {{ dict.label.DATASOURCE_TYPE[scope.row.datasourceType] }}
          </template>
        </el-table-column>
        <el-table-column v-if="columns.visible('datasourceSchema')" prop="datasourceSchema" label="数据库SCHEMA"
                         width="120"/>
        <el-table-column v-if="columns.visible('datasourceDriver')" prop="datasourceDriver" label="数据库驱动"
                         :show-overflow-tooltip="true" width="140"/>
        <el-table-column v-if="columns.visible('datasourceUrl')" prop="datasourceUrl" label="连接URL"
                         :show-overflow-tooltip="true" width="450"/>
        <el-table-column v-if="columns.visible('datasourceUser')" prop="datasourceUser" label="用户名"/>
        <!--<el-table-column v-if="columns.visible('datasourcePassword')" prop="datasourcePassword" label="密码" />-->
        <el-table-column v-if="columns.visible('datasourceDesc')" prop="datasourceDesc" label="描述"/>
        <el-table-column v-if="columns.visible('crtUserCode')" prop="crtUserCode" label="创建用户"/>
        <!--<el-table-column v-if="columns.visible('crtOrgCode')" prop="crtOrgCode" label="创建机构" />-->
        <el-table-column v-if="columns.visible('crtDate')" prop="crtDate" width="140" label="创建时间">
          <template slot-scope="scope">
            <span>{{ parseTime(scope.row.crtDate) }}</span>
          </template>
        </el-table-column>
        <el-table-column v-if="columns.visible('updUserCode')" prop="updUserCode" label="修改用户"/>
        <!--<el-table-column v-if="columns.visible('updOrgCode')" prop="updOrgCode" label="修改机构" />-->
        <el-table-column v-if="columns.visible('updDate')" prop="updDate" width="140" label="修改时间">
          <template slot-scope="scope">
            <span>{{ parseTime(scope.row.updDate) }}</span>
          </template>
        </el-table-column>
        <el-table-column v-if="columns.visible('id')" prop="id" label="数据源ID"/>
        <el-table-column v-if="columns.visible('tenant')" prop="tenant" label="租户"/>
        <el-table-column v-if="columns.visible('datasourceDriverType')" prop="datasourceDriverType" label="数据库驱动类型"/>
        <el-table-column v-if="columns.visible('maxConnNum')" prop="maxConnNum" label="最大连接数"/>
        <el-table-column v-if="columns.visible('vallidationMethod')" prop="vallidationMethod" label="验证方式"/>
        <el-table-column v-if="columns.visible('vallidationSql')" prop="vallidationSql" label="验证SQL"/>
        <el-table-column v-if="columns.visible('dbCharset')" prop="dbCharset" label="源字符集"/>
        <el-table-column v-if="columns.visible('dbToCharset')" prop="dbToCharset" label="目标字符集"/>
        <el-table-column v-if="columns.visible('quoteString')" prop="quoteString" label="引用标识符"/>
        <el-table-column v-if="columns.visible('transitionIsolation')" prop="transitionIsolation" label="事务隔离级别"/>
        <el-table-column v-permission="['admin','indDatasource:edit','indDatasource:del']" label="操作" width="100px"
                         align="center" fixed="right">
          <template slot-scope="scope">
<!--            <el-button
                type="success"
                v-permission="permission.details"
                class="filter-item"
                icon="el-icon-tickets"
                size="mini"
                style="margin-bottom:3px !important"
                @click="handleInfo(scope.row)"
            />-->
<!--            <udOperation
                :data="scope.row"
                :permission="permission"
                style="display:inline-block;"
            />-->
            <el-link v-permission="permission.edit" :disabled="disabledEdit" type="primary"  @click="crud.toEdit(scope.row)" >修改</el-link>
            <el-link v-permission="permission.del" :disabled="disabledDle" type="primary"  @click="toDelete(scope.row)">删除</el-link>
          </template>
        </el-table-column>
      </el-table>
      <!--分页组件-->
      <pagination/>
    </div>
  </div>
</template>

<script>
import crudIndDatasource from '../../../api/datasources/indDatasource'
import CRUD, {presenter, header, form, crud} from '@crud/crud'
import rrOperation from '@crud/RR.operation'
import crudOperation from '@crud/CRUD.operation'
import udOperation from '@crud/UD.operation'
import pagination from '@crud/Pagination'
import {test, saveTableAndColumnForList} from '../../../api/datasources/indDatasource'
import {getTableList, getTableListById} from '../../../api/datasources/indDataTable'
import {getColumnListByDatabase, saveColumnList} from '../../../api/datasources/indDataColumn'

// crud交由presenter持有
const defaultCrud = CRUD({
  title: '数据源',
  url: crudIndDatasource.url,
  sort: 'id,desc',
  crudMethod: {...crudIndDatasource.method}
})
const defaultForm = {
  datasourceName: null,
  datasourceType: null,
  datasourceSchema: null,
  datasourceDriver: null,
  datasourceUrl: null,
  datasourceUser: null,
  datasourcePassword: null,
  datasourceDesc: null,
  crtUserCode: null,
  crtOrgCode: null,
  crtDate: null,
  updUserCode: null,
  updOrgCode: null,
  updDate: null,
  id: null,
  tenant: null,
  datasourceDriverType: null,
  maxConnNum: null,
  vallidationMethod: null,
  vallidationSql: 'SELECT 1 FROM DUAL',
  dbCharset: null,
  dbToCharset: null,
  quoteString: null,
  transitionIsolation: null
}
export default {
  name: 'IndDatasource',
  components: {pagination, crudOperation, rrOperation, udOperation},
  mixins: [presenter(defaultCrud), header(), form(defaultForm), crud()],
  dicts: ['DATASOURCE_TYPE'],
  data() {
    return {
      table: {
        columns: {
          id: 'hidden',
          tenant: 'hidden',
          datasourceDriverType: 'hidden',
          datasourceDriver: 'hidden',
          /*datasourceUrl: 'hidden',*/
          maxConnNum: 'hidden',
          vallidationMethod: 'hidden',
          vallidationSql: 'hidden',
          dbCharset: 'hidden',
          dbToCharset: 'hidden',
          quoteString: 'hidden',
          transitionIsolation: 'hidden',
          datasourceDesc: 'hidden'
        }
      },
      show: false,
      showDataInfo: false,
      showTable: false,
      showColumnInfo: false,
      loading: true,
      editForm: {
        tableName: '',
        tableDesc: ''
      },
      dataSourceId: '',
      tabName: '',
      showType: 'primary',
      buttonName: '高级选项',
      tableData: [],
      columnData: [],
      tempData: [],
      resultData: [],
      passw: 'password',
      icon: 'el-input__icon el-icon-view',
      permission: {
        add: ['admin', 'indDatasource:add'],
        edit: ['admin', 'indDatasource:edit'],
        del: ['admin', 'indDatasource:del'],
        dataBaseManage: ['admin', 'dataBaseManage:del'],
        details: ['admin', 'indDatasource:details']
      },
      rules: {
        datasourceName: [
          {required: true, message: '数据源名称不能为空', trigger: 'blur'}
        ],
        datasourceType: [
          {required: true, message: '数据库类型不能为空', trigger: 'blur'}
        ],
        datasourceSchema: [
          {required: true, message: '数据库SCHEMA不能为空', trigger: 'blur'}
        ],
        datasourceDriver: [
          {required: true, message: '数据库驱动不能为空', trigger: 'blur'}
        ],
        datasourceUrl: [
          {required: true, message: '连接URL不能为空', trigger: 'blur'}
        ],
        datasourceUser: [
          {required: true, message: '用户名不能为空', trigger: 'blur'}
        ],
        datasourcePassword: [
          {required: true, message: '密码不能为空', trigger: 'blur'}
        ]
      }
    }
  },
  created() {
    this.$nextTick(() => {
      // const para = {
      // 'dataSource_id': 'd123',
      // 'table_id': 't1'
      // }
      // getColumnListById(para).then(data => {
      // console.log('=====getColumnListById====>>>>', data)
      // })
    })
  },
  methods: {
    // 获取数据前设置好接口地址
    [CRUD.HOOK.beforeRefresh]() {
      return true
    },
    toDelete(data) {
      //批量删除
      this.$confirm('确认删除数据源?', '删除数据源', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      }).then(() => {
        this.crud.doDelete(data);
      })
    },
    // 密码的隐藏和显示
    showPass() {
      // 点击图标是密码隐藏或显示
      if (this.passw === 'text') {
        this.passw = 'password'
        // 更换图标
        // this.icon="el-input__icon el-icon-view"
      } else {
        this.passw = 'text'
        // this.icon="el-input__icon el-icon-view"
      }
    },
    setDriverType() {
      this.form.datasourceDriverType = this.form.datasourceType
      if (this.form.datasourceType === 'mysql') {
        this.form.datasourceDriver = 'com.mysql.jdbc.Driver'
        this.form.datasourceUrl = 'jdbc:mysql://<servername>:<port>/<database>?useOldAliasMetadataBehavior=true&useUnicode=true&characterEntableFlag=GBK&zeroDateTimeBehavior=convertToNull'
      } else if (this.form.datasourceType === 'oracle') {
        this.form.datasourceDriver = 'oracle.jdbc.driver.OracleDriver'
        this.form.datasourceUrl = 'jdbc:oracle:thin:@<ip>:1521/<serviceName>'
      } else if (this.form.datasourceType === 'db2') {
        this.form.datasourceDriver = 'com.ibm.db2.jcc.DB2Driver'
        this.form.datasourceUrl = 'jdbc:db2://<servername>:<port>/<database>'
      } else if (this.form.datasourceType === 'db2') {
        this.form.datasourceDriver = 'com.ibm.db2.jcc.DB2Driver'
        this.form.datasourceUrl = 'jdbc:db2://<servername>:<port>/<database>'
      } else if (this.form.datasourceDriverType === 'postgresql') {
        this.form.datasourceDriver = 'org.postgresql.Driver'
        this.form.datasourceUrl = 'jdbc:postgresql://<servername>:<port>/<database>'
      } else {
        this.form.datasourceDriver = null
        this.form.datasourceUrl = null
      }
    },
    showInfo(show) {
      if (show) { // true 关闭高级选项
        this.show = false
        this.showType = 'primary'
        this.buttonName = '高级选项'
      } else {
        this.show = true // false 打开高级选项
        this.showType = 'primary'
        this.buttonName = '隐藏高级选项'
      }
    },
    doTest() {
      this.$refs['form'].validate((valid) => {
        if (!valid) { // rules规则校验不通过
          return
        } else {
          test(this.form).then(data => {
            // console.log("测试数据源返回数据", data)
            if (data.code === 0) {
              this.$message.success({
                message: '连接成功'
              })
            } else {
              this.$message.error({
                message: '数据源连接错误'
              })
            }
          })
        }
      })
    },
    dataBaseManage(data, index) {
      let tempId
      if (index === 1) { // 只选中一行 取该行数据源id
        tempId = data.id
      } else { // 未选行 默认查询local本地数据源
        tempId = 'local'
      }
      this.tableData = []
      this.resultData = []
      this.columnData = []
      this.tempData = []
      this.tabName = null
      this.dataSourceId = tempId
      this.loading = true
      // 查询已有表
      getTableListById(tempId).then(data => {
        if (data.code === 0) {
          this.resultData = data.data
          console.log('=====resultData====>>>>', this.resultData)
        } else {
          this.resultData = []
          this.$message.error({
            message: '数据源连接错误'
          })
        }
      })
      // 查询全部表
      setTimeout(() => {
        getTableList(tempId).then(data => {
          if (data.code === 0) {
            this.loading = false
            this.tableData = data.data
            this.tempData = data.data
            console.log('=====tableData====>>>>', this.tableData)
            // 做默认选中遍历
            this.$nextTick(function () {
              this.resultData.forEach(item => {
                for (let i = 0; i < this.tableData.length; i++) {
                  if (item.tableName === this.tableData[i].tableName) {
                    this.tableData.splice(i, 1)
                    return false
                  }
                }
              })
            })
          } else {
            this.tableData = []
            this.loading = false
            this.$message.error({
              message: '数据源连接错误'
            })
          }
        })
      }, 1000)
      this.showTable = true
    },
    select(selection, row) {
      this.$nextTick(function () {
        if (row.tableFlag === '1') {
          this.$set(row, 'tableFlag', '') // 取消选中
        } else {
          this.$set(row, 'tableFlag', '1') // 选中
        }
      })
    },
    selectColumn(selection, row) {
      this.$nextTick(function () {
        if (row.columnFlag === '1') {
          this.$set(row, 'columnFlag', '') // 取消选中
        } else {
          this.$set(row, 'columnFlag', '1') // 选中
        }
      })
    },
    selectAll(selection) {
      this.$nextTick(function () {
        if (selection.length === this.tableData.length) { // 取消全选
          for (let i = 0; i < this.tableData.length; i++) {
            this.$set(this.tableData[i], 'tableFlag', '1')
          }
        } else {
          for (let i = 0; i < this.tableData.length; i++) {
            this.$set(this.tableData[i], 'tableFlag', '') // 全部选中
          }
        }
      })
    },
    selectAllColumn(selection) {
      this.$nextTick(function () {
        if (selection.length === this.columnData.length) { // 取消全选
          for (let i = 0; i < this.columnData.length; i++) {
            this.$set(this.columnData[i], 'columnFlag', '1')
          }
        } else {
          for (let i = 0; i < this.columnData.length; i++) {
            this.$set(this.columnData[i], 'columnFlag', '') // 全部选中
          }
        }
      })
    },
    selectRightAll(selection) {
      this.$nextTick(function () {
        if (selection.length === this.resultData.length) { // 取消全选
          for (let i = 0; i < this.resultData.length; i++) {
            this.$set(this.resultData[i], 'tableFlag', '1')
          }
        } else {
          for (let i = 0; i < this.resultData.length; i++) {
            this.$set(this.resultData[i], 'tableFlag', '') // 全部选中
          }
        }
      })
    },
    save() {
      console.log('=====resultData====>>>>', this.resultData)
      saveTableAndColumnForList(this.resultData, this.dataSourceId).then(data => {
        if (data.code === 0) {
          console.log('保存成功', data.code)
        } else {
          console.log('保存失败', data.code)
        }
      })
      this.$message.success({
        message: '保存成功'
      })
      this.showTable = false
      this.tableData = []
    },
    searchName() {
      this.$nextTick(function () {
        var tabName = (this.tabName === null) ? '' : this.tabName
        let temp = this.tempData
        let result = this.resultData
        for (let i = 0; i < temp.length; i++) {
          for (let j = 0; j < result.length; j++) {
            if (temp[i].tableName === result[j].tableName) {
              temp.splice(i, 1)
            }
          }
        }
        let data = []
        data = temp.filter(function (row) {
          return row.tableName.indexOf(tabName) > -1
        })
        this.tableData = data
      })
    },
    selectLeft() {
      let td = this.tableData.filter(function (row) {
        if (row.tableFlag === '1') {
          return true
        } else {
          return false
        }
      })
      if (td.length === 0) {
        return false
      }
      this.$nextTick(function () {
        let leftData = []
        let rightData = this.resultData
        this.tableData.forEach(row => {
          if (row.tableFlag === '1') {
            rightData.push(row)
          }
        })
        leftData = this.tableData.filter(function (row) {
          if (row.tableFlag === '1') {
            return false
          } else {
            return true
          }
        })
        leftData.forEach(row => {
          this.$set(row, 'tableFlag', '')
        })
        rightData.forEach(row => {
          this.$set(row, 'tableFlag', '')
        })
        this.tableData = leftData
        this.resultData = rightData
      })
    },
    selectRight() {
      let td = this.resultData.filter(function (row) {
        if (row.tableFlag === '1') {
          return true
        } else {
          return false
        }
      })
      if (td.length === 0) {
        return false
      }
      this.$nextTick(function () {
        let leftData = this.tableData
        let rightData = []
        this.resultData.forEach(row => {
          if (row.tableFlag === '1') {
            leftData.push(row)
          }
        })
        rightData = this.resultData.filter(function (row) {
          if (row.tableFlag === '1') {
            return false
          } else {
            return true
          }
        })
        leftData.forEach(row => {
          this.$set(row, 'tableFlag', '')
        })
        rightData.forEach(row => {
          this.$set(row, 'tableFlag', '')
        })
        this.tableData = leftData
        this.resultData = rightData
      })
    },
    handleInfo(row) {
      this.form.id = row.id
      this.form.datasourceName = row.datasourceName
      this.form.datasourceType = row.datasourceType
      this.form.datasourceDriverType = row.datasourceDriverType
      this.form.datasourceDriver = row.datasourceDriver
      this.form.datasourceSchema = row.datasourceSchema
      this.form.datasourceDesc = row.datasourceDesc
      this.form.datasourceUrl = row.datasourceUrl
      this.form.datasourceUser = row.datasourceUser
      this.form.datasourcePassword = row.datasourcePassword
      this.form.tenant = row.tenant
      this.form.maxConnNum = row.maxConnNum
      this.form.vallidationMethod = row.vallidationMethod
      this.form.vallidationSql = row.vallidationSql
      this.form.dbCharset = row.dbCharset
      this.form.dbToCharset = row.dbToCharset
      this.form.quoteString = row.quoteString
      this.form.transitionIsolation = row.transitionIsolation
      this.form.crtUserCode = row.crtUserCode
      this.form.crtOrgCode = row.crtOrgCode
      this.form.crtDate = this.parseTime(row.crtDate)
      this.form.updUserCode = row.updUserCode
      this.form.updOrgCode = row.updOrgCode
      this.form.updDate = this.parseTime(row.updDate)
      this.showDataInfo = true
    },
    handleColumn(row) {
      this.columnData = []
      getColumnListByDatabase(this.dataSourceId, row.tableName).then(data => {
        console.log("========getColumnListByDatabase====>>>>", data)
        if (data.code === 0) {
          this.columnData = data.data
          this.$nextTick(function () {
            this.columnData.forEach(row => {
              if (row.columnFlag === '1') {
                this.$refs.multipleTable.toggleRowSelection(row, true)
              }
            })
          })
        } else {
          this.columnData = []
        }
      })
      this.showColumnInfo = true
    },
    saveColumnInfo() {
      console.log('=====columnData====>>>>', this.columnData)
      saveColumnList(this.columnData).then(data => {
        if (data.code === 0) {
          this.$message.success({
            message: '保存成功'
          })
        } else {
          this.$message.error({
            message: '保存失败'
          })
        }
      })
      this.showColumnInfo = false
      this.columnData = []
    }

  }
}
</script>

<style scoped>
.tableDiv {
  border: 1px solid #dfe6ec;
  overflow: auto;
  height: 452px;
  width: 100%;
  margin-top: 10px;
}

.el-table /deep/ .selectionInfo.cell .el-checkbox__inner {
  margin-left: 3px;
  position: relative;
}

.el-table /deep/ .selectionInfo.cell:before {
  content: '全选';
  position: absolute;
  left: 30px;
}

.dialog-footer {
  overflow: auto;
  height: 35px;
  text-align: center;
  margin-top: 10px;
}

.left-footer {
  height: 35px;
  margin-left: 30%;
  margin-top: 150%;
  float: left;

}

.right-footer {
  height: 35px;
  margin-left: 30%;
  margin-top: 10%;
  float: left;
}

.leftTable {
  overflow: auto;
  height: 450px;
  width: 45%;
  float: left;
}

.rightTable {
  overflow: auto;
  height: 450px;
  width: 45%;
  float: right;
}

.buttonDiv {
  overflow: auto;
  height: 450px;
  width: 10%;
  float: left;
}
</style>
