<template>
  <div>
    <div v-if="dictName === ''">
      <div class="my-code">点击参数查看详情</div>
    </div>
    <div v-else>
      <!--工具栏-->
      <div class="head-container">
        <!-- 搜索 -->
        <el-input
          v-model="query.label"
          clearable
          size="small"
          placeholder="输入参数标签查询"
          style="width: 200px;"
          class="filter-item"
          @keyup.enter.native="toQuery"
        />
        <el-button class="filter-item" type="success" icon="el-icon-search" @click="toQuery">搜索</el-button>
      </div>
      <!--表单组件-->
      <el-dialog
        append-to-body
        :close-on-click-modal="false"
        :before-close="cancel"
        :visible.sync="dialog"
        :title="getFormTitle()"
        width="500px"
      >
        <el-form ref="form" :model="form" :rules="rules" size="small" label-width="80px">
          <el-form-item label="参数标签" prop="label">
            <el-input v-model="form.label" style="width: 370px;" />
          </el-form-item>
          <el-form-item label="参数值" prop="value">
            <el-input v-model="form.value" style="width: 370px;" />
          </el-form-item>
          <el-form-item label="排序" prop="sort">
            <el-input-number
              v-model.number="form.sort"
              :min="0"
              :max="999"
              controls-position="right"
              style="width: 370px;"
            />
          </el-form-item>
          <el-form-item label="状态" prop="enabled">
            <el-switch v-model="form.enabled"
                       inactive-color="#ff4949"
                       active-text="激活"
                       inactive-text="禁用"></el-switch>
          </el-form-item>
        </el-form>
        <div slot="footer" class="dialog-footer">
          <el-button type="success" plain round @click="cancel">取消</el-button>
          <el-button :loading="loading" type="success" round @click="submitMethod">确认</el-button>
        </div>
      </el-dialog>
      <!--表格渲染-->
      <el-table height="460" v-loading="loading" :data="data" style="width: 100%;">
        <el-table-column label="所属参数" min-width="110px">
          {{ dictName }}
        </el-table-column>
        <el-table-column prop="label" min-width="100px" label="参数标签" />
        <el-table-column prop="value" label="参数值" />
        <el-table-column prop="sort" width="50px" label="排序" />
        <el-table-column label="状态" width="50px" align="center" prop="enabled">
          <template slot-scope="scope">
            <el-tooltip effect="dark" :content="dict.label['user_status'][scope.row.enabled]" placement="top-start">
              <el-switch
                v-model="scope.row.enabled"
                inactive-color="#ff4949"
                disabled
              />
            </el-tooltip>
<!--            {{ dict.label.user_status[scope.row.enabled] }}-->
          </template>
        </el-table-column>
        <el-table-column
          v-if="checkPermission(['admin','dict:edit','dict:del'])"
          label="操作"
          width="100px"
          align="center"
          fixed="right"
        >
          <template slot-scope="scope">
            <el-link
              v-permission="['admin','dict:edit']"
              type="primary"
              @click="showEditFormDialog(scope.row)"
            >修改</el-link>
            <el-popover
              :ref="scope.row.id"
              v-permission="['admin','dict:del']"
              placement="top"
              width="180"
            >
              <p>确定删除本条数据吗？</p>
              <div style="text-align: right; margin: 0">
                <el-button type="success" plain round @click="$refs[scope.row.id].doClose()">取消</el-button>
                <el-button :loading="delLoading" type="success" round @click="delMethod(scope.row.id)">确定</el-button>
              </div>
              <el-link slot="reference" type="primary">删除</el-link>
            </el-popover>
          </template>
        </el-table-column>
      </el-table>
      <!--分页组件-->
      <el-pagination
          small
        :total="total"
        :current-page="page + 1"
        background
        style="margin-top: 8px;"
        layout="total, prev, pager, next, sizes"
        @size-change="sizeChange"
        @current-change="pageChange"
      />
    </div>
  </div>
</template>

<script>
  import crud from '@eladmin/mixins/crud'
  import crudDictDetail,{getList} from '../../../api/system/dictDetail'
  import {getDicts} from "eladmin-system/src/api/system/dict";

  export default {
    mixins: [crud],
    dicts: ['user_status'],
    data() {
      return {
        title: '参数详情',
        sort: ['sort,asc', 'id,desc'],
        crudMethod: { ...crudDictDetail },
        dictName: '',
        detailArr:[],
        form: { id: null, label: null, value: null, dict: { id: null }, sort: 999, enabled: true },
        rules: {
          label: [
            { required: true, message: '请输入参数标签', trigger: 'blur' }
          ],
          sort: [
            { required: true, message: '请输入序号', trigger: 'blur', type: 'number' }
          ],
          value: [
              { required: true, message: '请输入参数值', trigger: 'blur' }
          ]
        }
      }
    },
    methods: {
      // 获取数据前设置好接口地址
      beforeInit() {
        this.url = 'api/dictDetail'
        if (this.dictName) {
          this.params['dictName'] = this.dictName
        }
        getList(this.dictName).then(data =>{
          this.detailArr = data.content
        })
        return true
      },
      beforeSubmitMethod(){
        for(var i=0;i<Object.keys(this.detailArr).length;i++){
          if(this.form.id == null){
            if(this.form.label == this.detailArr[i].label){
              this.$message({
                message: '参数标签不可以重复！',
                type: 'error'
              });
              return false;
            }else if(this.form.value == this.detailArr[i].value){
              this.$message({
                message: '参数值不可以重复！',
                type: 'error'
              });
              return false;
            }
          }else{
            for(var j=0;j<Object.keys(this.detailArr).length;j++){
              if(this.form.id == this.detailArr[j].id){
                this.detailArr.splice(j,1)
                break;
              }
            }
            if(this.form.label == this.detailArr[i].label){
              this.$message({
                message: '参数标签不可以重复！',
                type: 'error'
              });
              return false;
            }else if(this.form.value == this.detailArr[i].value){
              this.$message({
                message: '参数值不可以重复！',
                type: 'error'
              });
              return false;
            }
          }
        }
        return true;
      },
      afterEditMethod(){
        getList(this.dictName).then(data =>{
          this.allDate = data
        })
      },
      afterDelMethod(){
        getList(this.dictName).then(data =>{
          this.allDate = data
        })
      },
    },
  }
</script>

<style rel="stylesheet/scss" lang="scss" scoped>
::v-deep  .el-input-number .el-input__inner {
    text-align: left;
  }
</style>
