<template>
  <div class="app-container">
    <el-row>
      <el-col>
        <!--工具栏-->
        <div class="head-container">
          <div>
            <span v-if="crud.props.searchToggle">
              <!-- 搜索 -->
              <el-input
                  v-model="query.blurry"
                  size="small"
                  clearable
                  placeholder="输入名称或者描述搜索"
                  style="width: 150px;"
                  class="filter-item"
                  @keyup.enter.native="crud.toQuery"
              />
              <el-date-picker
                  v-model="query.createTime"
                  :default-time="['00:00:00','23:59:59']"
                  type="daterange"
                  range-separator=":"
                  size="small"
                  class="date-item"
                  value-format="yyyy-MM-dd HH:mm:ss"
                  start-placeholder="开始日期"
                  end-placeholder="结束日期"
              />
              <rrOperation :crud="crud"/>
            </span>
            <crudOperation style="margin-left: 9px" :permission="permission"/>
          </div>
        </div>
      </el-col>
    </el-row>

    <!-- 表单渲染 -->
    <el-dialog
        append-to-body
        :close-on-click-modal="false"
        :before-close="crud.cancelCU"
        :visible.sync="crud.status.cu > 0"
        :title="crud.status.title"
        width="650px"
    >
      <el-form ref="form" :model="form" :rules="rules" size="small" label-width="120px" @submit.native.prevent>
        <el-form-item label="所属租户" prop="tenant" v-if="isSuper">
          <el-select v-model="form.tenant" filterable placeholder="请选择" style="width: 90%;">
            <el-option
                v-for="item in tenantArr"
                :key="item.ID"
                :label="item.NAME"
                :value="item.ID"
            />
          </el-select>
        </el-form-item>
        <!--        <el-form-item label="角色编号" prop="id">
                  <el-input v-model="form.id" :disabled="crud.status.add != 1" style="width: 90%" />
                </el-form-item>-->
        <el-form-item label="角色名称" prop="name">
          <el-input v-model="form.name" style="width: 90%"/>
        </el-form-item>
        <!-- <el-form-item label="角色权限" prop="permission">
          <el-input v-model="form.permission" style="width: 200px;" />
        </el-form-item> -->
        <!--        <el-form-item label="角色级别" prop="level">
                  <el-input-number v-model.number="form.level" :min="1" :max="5" style="width: 100px;" />
                </el-form-item>
                <el-form-item label="数据权限" prop="dataScope">
                  <el-select v-model="form.dataScope" style="width: 90%" placeholder="请选择数据权限">
                    &lt;!&ndash;<el-option
                      v-for="item in dateScopes"
                      :key="item"
                      :label="item"
                      :value="item"
                    />&ndash;&gt;
                    <el-option
                      v-for="item in dict['DATA_AUTH_TYPE']"
                      :value="item.value"
                      :label="item.label"
                      :disabled="!isNaN(item['value']) && form.level>(item['value']+1)"
                    />
                  </el-select>
                </el-form-item>-->

        <!-- <el-form-item v-if="form.dataScope === '自定义'" label="数据权限" prop="depts">
          <treeselect v-model="form.depts" :options="depts" multiple style="width: 490px" placeholder="请选择" />
        </el-form-item>-->
        <el-form-item label="描述信息" prop="remark">
          <el-input v-model="form.remark" style="width: 90%" rows="5" type="textarea"/>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button type="success" plain round @click="crud.cancelCU">取消</el-button>
        <el-button :loading="crud.cu === 2" type="success" round @click="crud.submitCU">确认</el-button>
      </div>
    </el-dialog>
    <aForm ref="form1"/>
    <el-row :gutter="15" style="height: 540px" type="flex">
      <!--角色管理-->
      <el-col style="margin-bottom: 10px">
        <!-- <el-card class="box-card" shadow="never">
          <div slot="header" class="clearfix">
            <span class="role-span">角色列表</span>
          </div> -->
        <el-table height="100%"
                  ref="table"
                  v-loading="crud.loading"
                  highlight-current-row
                  style="width: 100%;"
                  :data="crud.data"
                  @selection-change="crud.selectionChangeHandler"
                  @current-change="handleCurrentChange"
        >
          <el-table-column :selectable="checkboxT" type="selection" width="55"/>
          <!--          <el-table-column v-if="columns.visible('id')" prop="id" label="编号" />-->
          <el-table-column v-if="columns.visible('name')" prop="name" label="名称"/>
          <el-table-column v-if="columns.visible('tenantName')" prop="tenantName" label="所属租户"/>
          <!-- <el-table-column v-if="columns.visible('permission')" prop="permission" label="角色权限" /> -->
          <!--          <el-table-column v-if="columns.visible('level')" prop="level" label="级别" width="160px">
                      <template slot-scope="scope">
                        {{ scope.row.level }}级
                      </template>
                    </el-table-column>
                    <el-table-column v-if="columns.visible('dataScope')" prop="dataScope" label="数据权限">
                      <template slot-scope="scope">
                        {{ dict.label["DATA_AUTH_TYPE"][scope.row.dataScope] }}
                      </template>
                    </el-table-column>-->
          <el-table-column v-if="columns.visible('remark')" :show-overflow-tooltip="true" prop="remark" label="描述"/>
          <el-table-column
              v-if="columns.visible('createTime')"
              :show-overflow-tooltip="true"
              width="135px"
              prop="createTime"
              label="创建日期"
          >
            <template slot-scope="scope">
              <span>{{ parseTime(scope.row.createTime) }}</span>
            </template>
          </el-table-column>
          <el-table-column
              v-permission="['admin','roles:edit','roles:del']"
              label="操作"
              width="200px"
              align="center"
              fixed="right"
          >
            <template slot-scope="scope">
              <span style="display: inline-block">
                <el-link
                  slot="left"
                  class="filter-item"
                  type="primary"
                  @click="toSelectUsers(scope.row)"
                >添加用户
                </el-link>
              </span>

              <udOperation
                  tagType="link"
                  :data="scope.row"
                  :permission="permission"
                  style="display:inline-block;"
                  :disabledEdit="setDisable(scope.row)"
                  :disabledDle="setDisable(scope.row)"
              />
            </template>
          </el-table-column>
        </el-table>

        <!-- </el-card> -->
      </el-col>
      <!-- 菜单授权
      <el-col :xs="24" :sm="24" :md="6" :lg="6" :xl="7">
        <el-card class="box-card" shadow="never">
          <div slot="header" class="clearfix">
            <el-tooltip class="item" effect="dark" content="选择指定角色分配菜单" placement="top">
              <span class="role-span">菜单分配</span>
            </el-tooltip>
            <el-button
              v-permission="['admin','roles:edit']"
              :disabled="!showButton"
              :loading="menuLoading"
              icon="el-icon-check"
              style="float: right; padding: 6px 9px"
              type="primary"
              @click="saveMenu"
            >保存</el-button>
          </div>
          <el-tree
            ref="menu"
            :data="menus"
            :default-checked-keys="menuIds"
            :props="defaultProps"
            check-strictly
            accordion
            show-checkbox
            node-key="id"
          />
        </el-card>
      </el-col> -->
    </el-row>
    <el-row>
      <el-col>
        <!--分页组件-->
        <pagination/>
      </el-col>
    </el-row>

  </div>
</template>

<script>
import crudRoles from '../../../api/system/role'
import {getDepts} from '../../../api/system/dept'
import CRUD, {presenter, header, form, crud} from '@crud/crud'
import rrOperation from '@crud/RR.operation'
import crudOperation from '@crud/CRUD.operation'
import udOperation from '@crud/UD.operation'
import pagination from '@crud/Pagination'
import Treeselect from '@riophae/vue-treeselect'
import '@riophae/vue-treeselect/dist/vue-treeselect.css'
import aForm from './form1'
import {getTenants, isSuperAdmin} from '@/api/indUserApply/indTenant'
// crud交由presenter持有
const defaultCrud = CRUD({title: '角色', url: 'api/roles', sort: 'id,asc', crudMethod: {...crudRoles}})
const defaultForm = {
  id: null,
  name: null,
  depts: [],
  remark: null,
  dataScope: 'o',
  roleLevel: 1,
  permission: 'default',
  tenant: null//租户 法人
}
export default {
  name: 'Role',
  components: {Treeselect, pagination, crudOperation, rrOperation, udOperation, aForm},
  mixins: [presenter(defaultCrud), header(), form(defaultForm), crud()],
  dicts: ['DATA_AUTH_TYPE'],
  data() {
    return {
      defaultProps: {children: 'children', label: 'label'},
      dateScopes: ['全部', '本级', '自定义'], level: 3,
      currentId: 0, menuLoading: false, showButton: false,
      menus: [], menuIds: [], depts: [],
      isSuper: false,
      tenantArr: [],
      permission: {
        add: ['admin', 'roles:add'],
        edit: ['admin', 'roles:edit'],
        del: ['admin', 'roles:del']
      },
      rules: {
        id: [
          {required: true, message: '请输入角色编号', trigger: 'blur'}],
        name: [
          {required: true, message: '请输入名称', trigger: 'blur'}],
        level: [
          {required: true, message: '请输入级别', trigger: 'blur'}
        ],
        tenant: [
          {required: true, message: '所属租户不能为空', trigger: 'blur'}
        ]
        // ,permission: [
        //   { required: true, message: '请输入权限', trigger: 'blur' }
        // ]
      }
    }
  },
  created() {
    // this.getMenus()
    crudRoles.getLevel().then(data => {
      this.level = data.level
      // console.log(this.level)
    })
    this.$nextTick(() => {
      this.crud.toQuery()
    })
    this.isSuperAdmin();
    this.getTenants();
    this.resetQuery()
  },
  methods: {
    resetQuery() {
      this.crud.resetQuery(false);
      this.crud.refresh()
    },
    toSelectUsers(data) {
      const _this = this.$refs.form1
      _this.title = '当前角色[' + data.name + ']'
      _this.roleId = data.id
      _this.roleLevel = data.level
      _this.getDeptDatas()
      // _this.toQueryUser()
      _this.getUserByRoleId()
      _this.table.data = []
      _this.dialog = true
    },
    // [CRUD.HOOK.afterRefresh]() {
    //   this.$refs.menu.setCheckedKeys([])
    // },
    // 编辑前
    [CRUD.HOOK.beforeToEdit](crud, form) {
      if (form.dataScope === '自定义') {
        this.getDepts()
      }
      const depts = []
      if (form.depts !== null && form.depts !== '') {
        form.depts.forEach(function (dept, index) {
          depts.push(dept.id)
        })
      }
      form.depts = depts
    },
    // 提交前做的操作
    [CRUD.HOOK.afterValidateCU](crud) {
      if (crud.form.dataScope === '自定义' && crud.form.depts.length === 0) {
        this.$message({
          message: '自定义数据权限不能为空',
          type: 'warning'
        })
        return false
      } else if (crud.form.dataScope === '自定义') {
        const depts = []
        crud.form.depts.forEach(function (data, index) {
          const dept = {id: data}
          depts.push(dept)
        })
        console.info(depts)
        crud.form.depts = depts
      } else {
        crud.form.depts = []
      }
      return true
    },
    [CRUD.HOOK.afterAddError](crud) {
      this.afterErrorMethod(crud)
    },
    [CRUD.HOOK.afterEditError](crud) {
      this.afterErrorMethod(crud)
    },
    afterErrorMethod(crud) {
      const depts = []
      crud.form.depts.forEach(function (dept, index) {
        depts.push(dept.id)
      })
      crud.form.depts = depts
    },
    // // 获取所有菜单
    // getMenus() {
    //   getMenusTree().then(res => {
    //     this.menus = res
    //   })
    // },
    // 触发单选
    handleCurrentChange(val) {
      if (val) {
        const _this = this
        // 清空菜单的选中
        // this.$refs.menu.setCheckedKeys([])
        // 保存当前的角色id
        this.currentId = val.id
        // this.showButton = this.level <= val.level
        // // 初始化
        // this.menuIds = []
        // // 菜单数据需要特殊处理
        // val.menus.forEach(function(data, index) {
        //   _this.menuIds.push(data.id)
        // })
      }
    },
    // // 保存菜单
    // saveMenu() {
    //   this.menuLoading = true
    //   const role = { id: this.currentId, menus: [] }
    //   // 得到半选的父节点数据，保存起来
    //   this.$refs.menu.getHalfCheckedNodes().forEach(function(data, index) {
    //     const menu = { id: data.id }
    //     role.menus.push(menu)
    //   })
    //   // 得到已选中的 key 值
    //   this.$refs.menu.getCheckedKeys().forEach(function(data, index) {
    //     const menu = { id: data }
    //     role.menus.push(menu)
    //   })
    //   crudRoles.editMenu(role).then(res => {
    //     this.crud.notify('保存成功', CRUD.NOTIFICATION_TYPE.SUCCESS)
    //     this.menuLoading = false
    //     this.update()
    //   }).catch(err => {
    //     this.menuLoading = false
    //     console.log(err.response.data.message)
    //   })
    // },
    // 改变数据
    update() {
      // 无刷新更新 表格数据
      crudRoles.get(this.currentId).then(res => {
        for (let i = 0; i < this.crud.data.length; i++) {
          if (res.id === this.crud.data[i].id) {
            this.crud.data[i] = res
            break
          }
        }
      })
    },
    // 获取部门数据
    getDepts() {
      getDepts({enabled: true}).then(res => {
        this.depts = res.content
      })
    },
    /* // 如果数据权限为自定义则获取部门数据
    changeScope() {
      if (this.form.dataScope === '自定义') {
        this.getDepts()
      }
    },*/
    checkboxT(row, rowIndex) {
      // return row.level >= this.level
      return true
    },
    setDisable(row) {
      if (row.id == 'R000') {
        return true;
      }
      return false;
    },
    getTenants() {
      getTenants().then(data => {
        if (data != null && data.code == '0000') {
          this.tenantArr = data.data
        }
      })
    },
    isSuperAdmin() {
      this.isSuper = isSuperAdmin();
    }
  }
}
</script>

<style rel="stylesheet/scss" lang="scss">
.role-span {
  font-weight: bold;
  color: #303133;
  font-size: 15px;
}
</style>

<style rel="stylesheet/scss" lang="scss" scoped>
::v-deep .el-input-number .el-input__inner {
  text-align: left;
}
</style>
